---
phase: 13-cinematic-camera-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/java/com/dread/mixin/CameraMixin.java
  - src/client/java/com/dread/client/DeathCinematicClientHandler.java
autonomous: true

must_haves:
  truths:
    - "Camera jumps to third-person instantly when death sequence starts"
    - "Camera pulls back to frame both player and Dread during first 1.5 seconds"
    - "Camera jump-cuts to Dread's face at 1.5 second mark (no smooth transition)"
    - "Camera stays locked on Dread's eyes for remaining 3 seconds"
    - "No camera shake during pull-back or face close-up phases"
  artifacts:
    - path: "src/client/java/com/dread/mixin/CameraMixin.java"
      provides: "Camera position injection via update() mixin"
      contains: "@Inject(method = \"update\""
    - path: "src/client/java/com/dread/client/DeathCinematicClientHandler.java"
      provides: "Cinematic position calculation for third-person and face close-up"
      contains: "getCameraPositionOffset"
  key_links:
    - from: "CameraMixin.java"
      to: "DeathCinematicClientHandler.getCameraPositionOffset()"
      via: "Direct method call in update() injection"
      pattern: "DeathCinematicClientHandler\\.getCameraPositionOffset\\(\\)"
---

<objective>
Implement core cinematic camera position control with third-person pull-back and face close-up phases.

Purpose: Create the camera movement system that transfers control from player to cinematic system, executing the multi-stage path (third-person pull-back -> jump cut -> face close-up) that makes the death sequence genuinely terrifying.

Output: Extended CameraMixin with position injection, refactored DeathCinematicClientHandler with new phase system for v2.0 cinematic camera.

**Design note (CAM-07):** Uses hardcoded tick boundaries (PULLBACK_END_TICKS=30, CINEMATIC_DURATION_TICKS=90) rather than a declarative keyframe system. Per RESEARCH.md: "Keyframes add complexity, 4.5s sequence doesn't need spline curves." This simpler approach matches the existing v1.2 phase pattern. A keyframe-based choreography system may be added in a future enhancement phase if more complex cinematics are needed.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-cinematic-camera-control/13-CONTEXT.md
@.planning/phases/13-cinematic-camera-control/13-RESEARCH.md
@src/client/java/com/dread/mixin/CameraMixin.java
@src/client/java/com/dread/client/DeathCinematicClientHandler.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CameraMixin with position injection</name>
  <files>src/client/java/com/dread/mixin/CameraMixin.java</files>
  <action>
Add @Shadow for Vec3d pos field to access camera position.

Add new @Inject into Camera.update() method at @At("TAIL") with order = 900 (same as rotation injection). This injection:
1. Checks if cinematic is active via DeathCinematicClientHandler.isCinematicActive()
2. Gets position offset from DeathCinematicClientHandler.getCameraPositionOffset()
3. Applies offset to this.pos by adding the offset vector

Method signature:
```java
@Inject(method = "update", at = @At("TAIL"), order = 900)
private void dread$applyCinematicPosition(
    BlockView area, Entity focusedEntity, boolean thirdPerson,
    boolean inverseView, float tickDelta, CallbackInfo ci
)
```

Import Vec3d from net.minecraft.util.math.Vec3d.
Import BlockView from net.minecraft.world.BlockView.
Import Entity from net.minecraft.entity.Entity.

Existing setRotation() injection remains unchanged.
  </action>
  <verify>
Build compiles with `gradlew build` (ensure JAVA_HOME set).
CameraMixin.java contains @Shadow for pos field and @Inject for update() method.
  </verify>
  <done>
CameraMixin injects into both setRotation() and update() at order 900, applying position offsets from DeathCinematicClientHandler.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor DeathCinematicClientHandler with v2.0 phase system</name>
  <files>src/client/java/com/dread/client/DeathCinematicClientHandler.java</files>
  <action>
Replace existing CinematicPhase enum with v2.0 phases:
- THIRD_PERSON_PULLBACK (ticks 0-30, 1.5s): Camera behind and above player, framing both player and Dread
- FACE_CLOSEUP (ticks 30-90, 3.0s): Camera locked on Dread's face, eyes centered

Update timing constants:
- PULLBACK_END_TICKS = 30 (1.5 seconds)
- CINEMATIC_DURATION_TICKS = 90 (4.5 seconds total)
- PULLBACK_DISTANCE = 5.0 (blocks behind player)
- PULLBACK_HEIGHT = 2.0 (blocks above player)
- FACE_DISTANCE = 0.4 (blocks from Dread's face, to avoid clipping inside model)

Add new public static method getCameraPositionOffset() that returns Vec3d:
1. If not cinematicActive, return Vec3d.ZERO
2. Based on currentPhase, call calculatePullbackPosition() or calculateFaceCloseupPosition()

Add private static method calculatePullbackPosition():
1. Get player's yaw from MinecraftClient.getInstance().player
2. Calculate offset behind player: x = -sin(yaw) * PULLBACK_DISTANCE, z = cos(yaw) * PULLBACK_DISTANCE
3. Add height: y = PULLBACK_HEIGHT
4. Return as Vec3d offset from player position

Add private static method calculateFaceCloseupPosition():
1. Get Dread entity from world using dreadEntityId
2. Get Dread's eye position via dread.getEyePos()
3. Get player's eye position
4. Calculate direction from Dread to player (normalized)
5. Position camera at dreadEyes + direction * FACE_DISTANCE
6. Return offset from player position (target - playerPos)

Update updatePhase() to use new tick boundaries (0-30 = THIRD_PERSON_PULLBACK, 30+ = FACE_CLOSEUP).

Update tick() method to use new CINEMATIC_DURATION_TICKS (90).

Remove or simplify the existing phase motion methods (applyImpactMotion, applyLiftMotion, etc.) since v2.0 uses position control rather than rotation animation. Keep basic yaw tracking to Dread during pull-back phase.

In startCinematic(), disable shake system by keeping getShakeYawOffset() and getShakePitchOffset() returning 0.0f (already the case).

IMPORTANT: Per CONTEXT.md, no camera shake during pull-back or close-up phases - pure frozen terror aesthetic. The existing shake return values of 0.0f are correct.
  </action>
  <verify>
Build compiles successfully.
DeathCinematicClientHandler contains getCameraPositionOffset() method.
CinematicPhase enum has THIRD_PERSON_PULLBACK and FACE_CLOSEUP values.
CINEMATIC_DURATION_TICKS equals 90.
  </verify>
  <done>
DeathCinematicClientHandler implements v2.0 phase system with third-person pull-back (1.5s) and face close-up (3s) position calculations. getCameraPositionOffset() returns correct Vec3d for each phase.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration, mixin coordination, and build</name>
  <files>src/client/java/com/dread/mixin/CameraMixin.java, src/client/java/com/dread/client/DeathCinematicClientHandler.java</files>
  <action>
Run full build to verify mixin integration:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7"
./gradlew build
```

Verify:
1. No mixin application errors
2. Camera.update() injection registered correctly
3. Method signatures match between CameraMixin and DeathCinematicClientHandler

**CRITICAL - Verify mixin coordination (CAM-04):**
Both injections use order=900 and operate on different Camera methods:
- setRotation() injection applies shake offsets (existing, rotation)
- update() injection applies position offsets (new, position)

Confirm they don't conflict by verifying:
- setRotation() injection modifies `this.yaw` and `this.pitch` only
- update() injection modifies `this.pos` only
- Both read from DeathCinematicClientHandler but don't share mutable state
- Order 900 on both ensures consistent priority with other camera mods

If build fails, check:
- Import statements (Vec3d, BlockView, Entity)
- Method visibility (getCameraPositionOffset must be public static)
- Mixin method parameter types match Camera.update() signature
  </action>
  <verify>
`gradlew build` completes with BUILD SUCCESSFUL.
No warnings about mixin application failures.
grep confirms both injections exist: `grep -c "@Inject.*order = 900" src/client/java/com/dread/mixin/CameraMixin.java` returns 2.
  </verify>
  <done>
Build passes with both camera injections active. Position (update) and rotation (setRotation) mixins at order=900 don't conflict - they modify different Camera fields (pos vs yaw/pitch).
  </done>
</task>

</tasks>

<verification>
1. Build completes successfully with `gradlew build`
2. CameraMixin.java contains both setRotation() and update() injections
3. DeathCinematicClientHandler.java contains getCameraPositionOffset() returning Vec3d
4. Phase timing: PULLBACK_END_TICKS = 30, CINEMATIC_DURATION_TICKS = 90
5. No runtime mixin errors in logs
</verification>

<success_criteria>
- CameraMixin injects into Camera.update() at order 900 to apply position offsets
- DeathCinematicClientHandler calculates third-person offset (5 blocks back, 2 up) during pull-back
- DeathCinematicClientHandler calculates face close-up position (0.4 blocks from Dread's eyes)
- Phase transition is instant (no interpolation between phases - jump cut aesthetic)
- Total cinematic duration remains 4.5 seconds (90 ticks)
- Build passes without mixin conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/13-cinematic-camera-control/13-01-SUMMARY.md`
</output>
