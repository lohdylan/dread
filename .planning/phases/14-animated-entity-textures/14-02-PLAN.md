---
phase: 14-animated-entity-textures
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/client/java/com/dread/client/DreadEntityModel.java
autonomous: true

must_haves:
  truths:
    - "Texture changes during death sequence (not static throughout)"
    - "Runes pulse with accelerating heartbeat rhythm during pull-back phase"
    - "Eyes open texture shown during face close-up phase"
    - "Idle state shows base texture with dim runes"
  artifacts:
    - path: "src/client/java/com/dread/client/DreadEntityModel.java"
      provides: "Cinematic-aware texture selection with pulse calculation"
      min_lines: 80
      exports: ["getTextureResource"]
  key_links:
    - from: "DreadEntityModel.getTextureResource()"
      to: "DeathCinematicClientHandler.getCinematicTimer()"
      via: "static method call for cinematic timing"
      pattern: "getCinematicTimer\\(\\)"
    - from: "DreadEntityModel.getTextureResource()"
      to: "DeathCinematicClientHandler.isInFaceCloseup()"
      via: "static method call for phase check"
      pattern: "isInFaceCloseup\\(\\)"
    - from: "DreadEntityModel.getTextureResource()"
      to: "DreadEntity.isPlayingDeathGrab()"
      via: "entity method call for state check"
      pattern: "isPlayingDeathGrab\\(\\)"
---

<objective>
Implement cinematic-synchronized texture selection in DreadEntityModel with heartbeat pulse timing.

Purpose: Make Dread's texture dynamically change during death sequence - accelerating rune pulse during pull-back phase, eyes open reveal during face close-up.

Output: Refactored DreadEntityModel with state-aware getTextureResource() that returns appropriate texture based on cinematic progress.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-animated-entity-textures/14-RESEARCH.md
@.planning/phases/14-animated-entity-textures/14-CONTEXT.md
@.planning/phases/14-animated-entity-textures/14-01-SUMMARY.md
@src/client/java/com/dread/client/DreadEntityModel.java
@src/client/java/com/dread/client/DeathCinematicClientHandler.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor DreadEntityModel with cinematic texture selection</name>
  <files>src/client/java/com/dread/client/DreadEntityModel.java</files>
  <action>
Refactor DreadEntityModel.getTextureResource() to select textures based on cinematic state:

1. Add static texture identifiers for all animation states (pulse 0/1/2, eyes_open)
2. Implement pulse frame calculation with accelerating heartbeat rhythm
3. Select texture based on: idle state vs kill sequence phase

**Texture selection logic:**

```java
@Override
public Identifier getTextureResource(DreadEntity entity) {
    // Check if entity is in death cinematic
    if (entity.isPlayingDeathGrab()) {
        int tick = DeathCinematicClientHandler.getCinematicTimer();

        if (tick >= 0) { // Cinematic active
            // Face close-up phase (30-90 ticks): Eyes open texture
            if (DeathCinematicClientHandler.isInFaceCloseup()) {
                return getEyesOpenTexture(entity.getFormVariant());
            }

            // Pull-back phase (0-30 ticks): Accelerating rune pulse
            int pulseFrame = calculatePulseFrame(tick);
            return getPulseTexture(entity.getFormVariant(), pulseFrame);
        }
    }

    // Idle state: Base texture (dim runes)
    return getIdleTexture(entity.getFormVariant());
}
```

**Heartbeat pulse timing (from CONTEXT.md):**
- Slow at start (60 BPM / 1.0s period) → Fast at end (200 BPM / 0.3s period)
- 0-10 ticks: 20-tick period → frame changes every 10 ticks
- 10-20 ticks: 12-tick period → frame changes every 6 ticks
- 20-30 ticks: 6-tick period → frame changes every 3 ticks
- Returns pulse frame 0/1/2 (dim/medium/bright)

**Pulse calculation:**

```java
/**
 * Calculate rune pulse frame based on accelerating heartbeat rhythm.
 * Pulse accelerates from slow (1.0s/beat) to fast (0.3s/beat) over 1.5s pull-back.
 *
 * @param tick Cinematic tick (0-30 for pull-back phase)
 * @return Pulse frame 0-2 (dim, medium, bright)
 */
private int calculatePulseFrame(int tick) {
    // Three zones with accelerating heartbeat
    if (tick < 10) {
        // Zone 1: Slow (20-tick period = 1.0s at 20 ticks/sec)
        // Toggle between dim(0) and medium(1)
        return ((tick / 10) % 2 == 0) ? 0 : 1;
    } else if (tick < 20) {
        // Zone 2: Medium (12-tick period = 0.6s)
        // Toggle between dim(0), medium(1), bright(2)
        int phase = ((tick - 10) / 4) % 3;
        return phase;
    } else {
        // Zone 3: Fast (6-tick period = 0.3s)
        // Rapid pulse to bright
        int phase = ((tick - 20) / 2) % 3;
        return phase;
    }
}
```

**Texture getters (support form variants):**

```java
private Identifier getPulseTexture(int variant, int pulseFrame) {
    String baseName = getVariantBaseName(variant);
    return Identifier.of("dread", "textures/entity/" + baseName + "_pulse_" + pulseFrame + ".png");
}

private Identifier getEyesOpenTexture(int variant) {
    String baseName = getVariantBaseName(variant);
    return Identifier.of("dread", "textures/entity/" + baseName + "_eyes_open.png");
}

private Identifier getIdleTexture(int variant) {
    // Existing switch logic, but use helper method
    return switch (variant) {
        case 1 -> TEXTURE_V2;
        case 2 -> TEXTURE_V3;
        default -> TEXTURE_BASE;
    };
}

private String getVariantBaseName(int variant) {
    return switch (variant) {
        case 1 -> "dread_variant2";
        case 2 -> "dread_variant3";
        default -> "dread_base";
    };
}
```

Add import for DeathCinematicClientHandler at top of file.
  </action>
  <verify>Build compiles: `export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew build --quiet`</verify>
  <done>DreadEntityModel.getTextureResource() returns different textures based on cinematic state: pulse textures during pull-back, eyes_open during face close-up, base texture during idle</done>
</task>

<task type="auto">
  <name>Task 2: Verify texture selection paths</name>
  <files>(verification only)</files>
  <action>
Verify that all texture paths generated by the new code match existing files:

1. Check that pulse texture files exist:
   - dread_base_pulse_0.png, dread_base_pulse_1.png, dread_base_pulse_2.png
   - Corresponding _glowmask files

2. Check that eyes_open texture files exist:
   - dread_base_eyes_open.png
   - dread_base_eyes_open_glowmask.png

3. Verify variant handling:
   - For variant 0: dread_base_* textures
   - For variant 1: Would look for dread_variant2_* textures (not created yet - that's OK, will fall back)
   - For variant 2: Would look for dread_variant3_* textures (not created yet - that's OK, will fall back)

Note: Variant textures (variant2_pulse_*, variant3_pulse_*) are not created in 14-01 since they require texture art work. The code will try to load them and fall back gracefully (GeckoLib shows missing texture warning but doesn't crash).
  </action>
  <verify>Run: `ls "X:/Vibe Coding/src/main/resources/assets/dread/textures/entity/" | grep -E "dread_base_(pulse|eyes)"`</verify>
  <done>All dread_base_* texture paths from code match existing files on disk</done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. DreadEntityModel imports DeathCinematicClientHandler
3. getTextureResource() checks entity.isPlayingDeathGrab() and cinematic timer
4. calculatePulseFrame() returns 0/1/2 based on accelerating heartbeat
5. Texture paths match placeholder files created in 14-01
</verification>

<success_criteria>
- Texture changes during death sequence (verified by reviewing code logic)
- Pulse frame calculation implements accelerating heartbeat (slow → fast)
- Face close-up phase shows eyes_open texture
- Idle state shows base texture (unchanged from before)
- Build compiles without texture-related errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-animated-entity-textures/14-02-SUMMARY.md`
</output>
