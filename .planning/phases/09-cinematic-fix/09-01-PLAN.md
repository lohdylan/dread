---
phase: 09-cinematic-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/java/com/dread/mixin/CameraMixin.java
  - src/client/java/com/dread/client/DeathCinematicClientHandler.java
  - src/main/resources/dread.mixins.json
autonomous: true

must_haves:
  truths:
    - "Camera shake during death cinematic is smooth without flickering"
    - "Player can clearly see Dread's grab animation throughout death sequence"
    - "Entity rotation is not modified by shake system"
  artifacts:
    - path: "src/client/java/com/dread/mixin/CameraMixin.java"
      provides: "Render-time camera shake injection"
      contains: "@Inject(method = \"setRotation\""
    - path: "src/client/java/com/dread/client/DeathCinematicClientHandler.java"
      provides: "Public shake offset getters, no entity rotation modification"
      exports: ["getShakeYawOffset", "getShakePitchOffset"]
    - path: "src/main/resources/dread.mixins.json"
      provides: "CameraMixin registration"
      contains: "CameraMixin"
  key_links:
    - from: "src/client/java/com/dread/mixin/CameraMixin.java"
      to: "DeathCinematicClientHandler"
      via: "getShakeYawOffset() and getShakePitchOffset() calls"
      pattern: "DeathCinematicClientHandler\\.getShake(Yaw|Pitch)Offset"
---

<objective>
Fix camera shake feedback loop by moving shake application from entity rotation to Camera mixin injection.

Purpose: Eliminate the "fighting" effect where entity AI/animation rotation updates conflict with shake offsets, causing janky/unreadable death cinematics.

Output: Smooth, coordinated death cinematic where camera shake is applied at render-time (after entity rotation finalized), allowing player to clearly see Dread's grab animation.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cinematic-fix/09-RESEARCH.md

# Relevant source files
@src/client/java/com/dread/client/DeathCinematicClientHandler.java
@src/client/java/com/dread/client/CameraShakeHandler.java
@src/client/java/com/dread/mixin/CrawlCameraMixin.java
@src/main/resources/dread.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CameraMixin for render-time shake injection</name>
  <files>src/client/java/com/dread/mixin/CameraMixin.java</files>
  <action>
Create new mixin that injects camera shake at render-time, following the pattern established by CrawlCameraMixin:

```java
package com.dread.mixin;

import com.dread.client.DeathCinematicClientHandler;
import net.minecraft.client.render.Camera;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

/**
 * Applies cinematic camera shake during death sequence.
 * Injects at render time (after entity rotation finalized) to avoid
 * feedback loop where entity AI fights with shake offsets.
 */
@Mixin(Camera.class)
public class CameraMixin {

    @Shadow
    private float pitch;

    @Shadow
    private float yaw;

    /**
     * Apply cinematic shake offsets to camera rotation.
     * Uses order = 900 to run before CrawlCameraMixin (default 1000).
     */
    @Inject(method = "setRotation", at = @At("TAIL"), order = 900)
    private void dread$applyCinematicShake(float yaw, float pitch, CallbackInfo ci) {
        if (!DeathCinematicClientHandler.isCinematicActive()) {
            return;
        }

        this.yaw += DeathCinematicClientHandler.getShakeYawOffset();
        this.pitch += DeathCinematicClientHandler.getShakePitchOffset();
    }
}
```

Key points:
- Use `order = 900` so shake applies BEFORE CrawlCameraMixin's pitch clamping (order 1000 default)
- Only apply when cinematic is active (guard prevents shake during normal gameplay)
- Add offsets to shadowed fields, not method parameters (fields are what get rendered)
  </action>
  <verify>File exists at correct path with @Mixin(Camera.class) annotation</verify>
  <done>CameraMixin.java created with @Inject at "setRotation" TAIL and proper shake offset application</done>
</task>

<task type="auto">
  <name>Task 2: Update DeathCinematicClientHandler - remove entity rotation, add getters</name>
  <files>src/client/java/com/dread/client/DeathCinematicClientHandler.java</files>
  <action>
Modify DeathCinematicClientHandler.java:

1. **Remove entity rotation modification** (lines 100-106 in tick() method):
   Delete this block:
   ```java
   // Apply shake offset to camera entity rotation
   if (cameraShake.isActive()) {
       float baseYaw = cameraEntity.getYaw();
       float basePitch = cameraEntity.getPitch();
       cameraEntity.setYaw(baseYaw + cameraShake.getYawOffset());
       cameraEntity.setPitch(basePitch + cameraShake.getPitchOffset());
   }
   ```

2. **Add public static getters** at end of class (before closing brace):
   ```java
   /**
    * Get yaw shake offset for Camera mixin.
    * Returns 0 if shake not active.
    */
   public static float getShakeYawOffset() {
       return cameraShake.getYawOffset();
   }

   /**
    * Get pitch shake offset for Camera mixin.
    * Returns 0 if shake not active.
    */
   public static float getShakePitchOffset() {
       return cameraShake.getPitchOffset();
   }
   ```

Root cause fix: Entity rotation was being modified every tick, but entity AI/animation also updates rotation. This created a feedback loop. By removing entity modification and exposing getters, the Camera mixin can apply shake at render-time AFTER all entity updates complete.
  </action>
  <verify>grep -n "cameraEntity.setYaw\|cameraEntity.setPitch" shows no matches (entity rotation code removed); grep "getShakeYawOffset\|getShakePitchOffset" shows getters exist</verify>
  <done>tick() no longer modifies entity rotation; getShakeYawOffset() and getShakePitchOffset() public static methods exist</done>
</task>

<task type="auto">
  <name>Task 3: Register CameraMixin and verify build</name>
  <files>src/main/resources/dread.mixins.json</files>
  <action>
Add "CameraMixin" to the client mixins array in dread.mixins.json.

Change from:
```json
"client": [
  "DeathScreenMixin",
  "ClientAttackMixin",
  "PlayerPoseMixin",
  "CrawlCameraMixin"
],
```

To:
```json
"client": [
  "DeathScreenMixin",
  "ClientAttackMixin",
  "PlayerPoseMixin",
  "CrawlCameraMixin",
  "CameraMixin"
],
```

Then run build verification:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && ./gradlew build
```

Build must succeed with no mixin-related errors.
  </action>
  <verify>`./gradlew build` succeeds with no errors</verify>
  <done>CameraMixin registered in dread.mixins.json and build passes</done>
</task>

</tasks>

<verification>
1. Build succeeds: `export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && ./gradlew build`
2. CameraMixin.java exists with @Mixin(Camera.class) and @Inject at setRotation TAIL
3. DeathCinematicClientHandler.java has no entity rotation modification (no setYaw/setPitch on cameraEntity)
4. DeathCinematicClientHandler.java has getShakeYawOffset() and getShakePitchOffset() public static methods
5. dread.mixins.json includes "CameraMixin" in client array
</verification>

<success_criteria>
- Build compiles without errors
- Camera shake applied via mixin injection, not entity rotation
- No entity rotation modification remains in DeathCinematicClientHandler
- CameraMixin properly registered
- Ready for in-game testing (death cinematic should be smooth, no flickering)
</success_criteria>

<output>
After completion, create `.planning/phases/09-cinematic-fix/09-01-SUMMARY.md`
</output>
