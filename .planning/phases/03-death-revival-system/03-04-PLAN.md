---
phase: 03-death-revival-system
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/client/java/com/dread/client/DownedStateClientHandler.java
  - src/client/java/com/dread/client/DownedHudOverlay.java
  - src/client/java/com/dread/DreadClient.java
  - src/main/resources/assets/dread/shaders/post/downed_blur.json
  - src/main/resources/assets/dread/shaders/program/downed_blur.fsh
  - src/main/resources/assets/dread/shaders/program/downed_blur.vsh
autonomous: true

must_haves:
  truths:
    - "Downed player sees heavy blur and vignette effects"
    - "Countdown timer displays remaining seconds on screen"
    - "Timer color changes from yellow to red as time runs out"
    - "Effects are removed on revival or spectator transition"
  artifacts:
    - path: "src/client/java/com/dread/client/DownedStateClientHandler.java"
      provides: "Shader effect management for downed state"
      exports: ["applyDownedEffects", "removeDownedEffects", "tick"]
    - path: "src/client/java/com/dread/client/DownedHudOverlay.java"
      provides: "HUD countdown timer display"
      exports: ["render"]
    - path: "src/main/resources/assets/dread/shaders/post/downed_blur.json"
      provides: "Post-processing shader definition"
  key_links:
    - from: "DownedStateClientHandler"
      to: "Satin ManagedShaderEffect"
      via: "shader initialization"
      pattern: "ShaderEffectManager\\.getInstance\\(\\)\\.manage"
    - from: "DownedHudOverlay"
      to: "HudRenderCallback"
      via: "HUD rendering event"
      pattern: "HudRenderCallback\\.EVENT\\.register"
    - from: "DownedStateClientHandler"
      to: "DownedStateUpdateS2C"
      via: "packet receiver"
      pattern: "registerGlobalReceiver.*DownedStateUpdateS2C"
---

<objective>
Implement downed state visual effects using Satin API shaders (blur + vignette) and HUD overlay for countdown timer.

Purpose: Create the claustrophobic, near-blind visual experience for downed players with a visible countdown to their permanent death.

Output:
- Heavy blur + vignette shader applied when player is downed
- Centered countdown timer showing MM:SS format
- Timer color interpolates yellow to red as time decreases
- Effects clean up properly on revival, disconnect, or spectator transition
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-death-revival-system/03-RESEARCH.md
@.planning/phases/03-death-revival-system/03-CONTEXT.md

# Dependencies
@.planning/phases/03-death-revival-system/03-01-SUMMARY.md
@.planning/phases/03-death-revival-system/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create downed state shader effects using Satin API</name>
  <files>
    src/main/resources/assets/dread/shaders/post/downed_blur.json
    src/main/resources/assets/dread/shaders/program/downed_blur.fsh
    src/main/resources/assets/dread/shaders/program/downed_blur.vsh
    src/client/java/com/dread/client/DownedStateClientHandler.java
  </files>
  <action>
    1. Create shader directory structure:
       - src/main/resources/assets/dread/shaders/post/
       - src/main/resources/assets/dread/shaders/program/

    2. Create downed_blur.json (post-processing shader definition):
       ```json
       {
         "targets": [
           "swap"
         ],
         "passes": [
           {
             "name": "downed_blur",
             "intarget": "minecraft:main",
             "outtarget": "swap",
             "uniforms": [
               {
                 "name": "BlurRadius",
                 "values": [15.0]
               },
               {
                 "name": "VignetteIntensity",
                 "values": [0.8]
               }
             ]
           },
           {
             "name": "blit",
             "intarget": "swap",
             "outtarget": "minecraft:main"
           }
         ]
       }
       ```

    3. Create downed_blur.vsh (vertex shader - simple passthrough):
       ```glsl
       #version 150

       in vec4 Position;
       in vec2 UV0;

       uniform mat4 ProjMat;
       uniform vec2 OutSize;

       out vec2 texCoord;

       void main() {
           vec4 outPos = ProjMat * vec4(Position.xy, 0.0, 1.0);
           gl_Position = vec4(outPos.xy, 0.2, 1.0);
           texCoord = UV0;
       }
       ```

    4. Create downed_blur.fsh (fragment shader with blur + vignette):
       ```glsl
       #version 150

       uniform sampler2D DiffuseSampler;
       uniform float BlurRadius;
       uniform float VignetteIntensity;
       uniform vec2 OutSize;

       in vec2 texCoord;
       out vec4 fragColor;

       void main() {
           vec2 pixelSize = 1.0 / OutSize;

           // Simple box blur
           vec4 color = vec4(0.0);
           float samples = 0.0;

           for (float x = -BlurRadius; x <= BlurRadius; x += 1.0) {
               for (float y = -BlurRadius; y <= BlurRadius; y += 1.0) {
                   vec2 offset = vec2(x, y) * pixelSize;
                   color += texture(DiffuseSampler, texCoord + offset);
                   samples += 1.0;
               }
           }
           color /= samples;

           // Vignette effect
           vec2 center = texCoord - 0.5;
           float dist = length(center) * 1.4142;  // Normalize to 0-1 for corners
           float vignette = 1.0 - (dist * VignetteIntensity);
           vignette = clamp(vignette, 0.2, 1.0);  // Don't go fully black

           // Desaturate slightly for horror effect
           float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));
           color.rgb = mix(color.rgb, vec3(gray), 0.3);

           // Darken overall
           color.rgb *= vignette * 0.6;

           fragColor = color;
       }
       ```

    5. Update DownedStateClientHandler.java with full Satin implementation:
       ```java
       package com.dread.client;

       import ladysnake.satin.api.managed.ManagedShaderEffect;
       import ladysnake.satin.api.managed.ShaderEffectManager;
       import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
       import net.minecraft.client.MinecraftClient;
       import net.minecraft.util.Identifier;

       /**
        * Handles client-side downed state visual effects.
        * Uses Satin API for post-processing blur and vignette.
        */
       public class DownedStateClientHandler {

           private static final Identifier DOWNED_SHADER_ID =
               Identifier.of("dread", "shaders/post/downed_blur.json");

           private static ManagedShaderEffect downedShader;
           private static boolean isLocalPlayerDowned = false;
           private static int remainingSeconds = 300;

           public static void initialize() {
               // Lazily initialize shader (auto-reloads on resolution change)
               downedShader = ShaderEffectManager.getInstance().manage(DOWNED_SHADER_ID);
           }

           public static void applyDownedEffects() {
               isLocalPlayerDowned = true;

               if (downedShader != null) {
                   // Configure shader uniforms
                   downedShader.setUniformValue("BlurRadius", 15.0f);
                   downedShader.setUniformValue("VignetteIntensity", 0.8f);
               }
           }

           public static void removeDownedEffects() {
               isLocalPlayerDowned = false;

               // Shader is automatically not rendered when isLocalPlayerDowned is false
               // (checked in render callback)
           }

           public static void updateRemainingTime(int seconds) {
               remainingSeconds = seconds;
           }

           public static int getRemainingSeconds() {
               return remainingSeconds;
           }

           public static boolean isLocalPlayerDowned() {
               return isLocalPlayerDowned;
           }

           public static void tick() {
               // Client-side countdown (for smoother display)
               // Server is authoritative; this is just visual interpolation
               if (isLocalPlayerDowned && remainingSeconds > 0) {
                   // Note: Actual countdown handled by server and synced via packets
               }
           }

           public static void renderShader(float tickDelta) {
               if (isLocalPlayerDowned && downedShader != null) {
                   downedShader.render(tickDelta);
               }
           }

           public static void register() {
               initialize();
               ClientTickEvents.END_CLIENT_TICK.register(client -> tick());
           }
       }
       ```

    Note: Satin API shader rendering is typically done via ManagedShaderEffect.render()
    called from a render event. The exact hook depends on Satin version.
    For 1.21, use ladysnake.satin.api.event.PostWorldRenderCallback.
  </action>
  <verify>
    Run `./gradlew build` to verify shader files are valid and class compiles.
    Verify shader JSON is valid JSON format.
  </verify>
  <done>
    - Post-processing shader created with blur + vignette effects
    - DownedStateClientHandler manages shader with Satin API
    - Shader uniforms configurable (BlurRadius, VignetteIntensity)
    - Effects can be applied and removed cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HUD countdown timer and register packet receivers</name>
  <files>
    src/client/java/com/dread/client/DownedHudOverlay.java
    src/client/java/com/dread/DreadClient.java
  </files>
  <action>
    1. Create DownedHudOverlay.java - HUD timer display:
       ```java
       package com.dread.client;

       import net.fabricmc.fabric.api.client.rendering.v1.HudRenderCallback;
       import net.minecraft.client.MinecraftClient;
       import net.minecraft.client.font.TextRenderer;
       import net.minecraft.client.gui.DrawContext;
       import net.minecraft.client.render.RenderTickCounter;
       import net.minecraft.util.math.MathHelper;

       /**
        * HUD overlay showing countdown timer when player is downed.
        * Timer shows MM:SS format, color transitions yellow to red.
        */
       public class DownedHudOverlay {

           private static final int MAX_TIME = 300;  // 5 minutes

           public static void register() {
               HudRenderCallback.EVENT.register(DownedHudOverlay::render);
           }

           private static void render(DrawContext context, RenderTickCounter tickCounter) {
               if (!DownedStateClientHandler.isLocalPlayerDowned()) {
                   return;
               }

               MinecraftClient client = MinecraftClient.getInstance();
               if (client.player == null) return;

               TextRenderer textRenderer = client.textRenderer;
               int remainingSeconds = DownedStateClientHandler.getRemainingSeconds();

               // Format as MM:SS
               int minutes = remainingSeconds / 60;
               int seconds = remainingSeconds % 60;
               String timerText = String.format("%d:%02d", minutes, seconds);

               // Calculate color (yellow to red interpolation)
               float timeRatio = (float) remainingSeconds / MAX_TIME;
               int color = interpolateColor(timeRatio);

               // Center horizontally, position above hotbar
               int textWidth = textRenderer.getWidth(timerText);
               int screenWidth = context.getScaledWindowWidth();
               int screenHeight = context.getScaledWindowHeight();

               int x = (screenWidth - textWidth) / 2;
               int y = screenHeight - 60;  // Above hotbar area

               // Draw with shadow for visibility
               context.drawTextWithShadow(textRenderer, timerText, x, y, color);

               // Draw "DOWNED" label above timer
               String label = "DOWNED";
               int labelWidth = textRenderer.getWidth(label);
               int labelX = (screenWidth - labelWidth) / 2;
               context.drawTextWithShadow(textRenderer, label, labelX, y - 12, 0xFFAA0000);
           }

           /**
            * Interpolate between red (0%) and yellow (100%) based on time remaining.
            */
           private static int interpolateColor(float ratio) {
               // Red: 0xFFFF0000, Yellow: 0xFFFFFF00
               // Interpolate green channel from 0 to 255

               int red = 255;
               int green = (int) (ratio * 255);
               int blue = 0;
               int alpha = 255;

               return (alpha << 24) | (red << 16) | (green << 8) | blue;
           }
       }
       ```

    2. Update DreadClient.java to register HUD overlay and remaining packet receivers:
       ```java
       // Add imports
       import com.dread.client.DownedHudOverlay;
       import com.dread.client.DownedStateClientHandler;
       import com.dread.network.packets.DownedStateUpdateS2C;
       import com.dread.network.packets.RemoveDownedEffectsS2C;
       import com.dread.network.packets.RevivalProgressS2C;
       import ladysnake.satin.api.event.PostWorldRenderCallback;

       // In onInitializeClient():

       // Register downed state handlers
       DownedStateClientHandler.register();
       DownedHudOverlay.register();

       // Register shader render callback (Satin)
       PostWorldRenderCallback.EVENT.register((camera, tickDelta, worldRenderContext) -> {
           DownedStateClientHandler.renderShader(tickDelta);
       });

       // Register packet receivers
       ClientPlayNetworking.registerGlobalReceiver(
           DownedStateUpdateS2C.ID,
           (payload, context) -> {
               context.client().execute(() -> {
                   if (payload.isDowned()) {
                       DownedStateClientHandler.applyDownedEffects();
                       DownedStateClientHandler.updateRemainingTime(payload.remainingSeconds());
                   } else {
                       DownedStateClientHandler.removeDownedEffects();
                   }
               });
           }
       );

       ClientPlayNetworking.registerGlobalReceiver(
           RemoveDownedEffectsS2C.ID,
           (payload, context) -> {
               context.client().execute(() -> {
                   DownedStateClientHandler.removeDownedEffects();
               });
           }
       );

       // RevivalProgressS2C receiver for progress bar (implemented in 03-05)
       ClientPlayNetworking.registerGlobalReceiver(
           RevivalProgressS2C.ID,
           (payload, context) -> {
               context.client().execute(() -> {
                   // TODO: Handle revival progress bar (Plan 03-05)
               });
           }
       );
       ```

    3. Ensure client mod.json has Satin as dependency:
       Check src/client/resources/fabric.mod.json and add if needed:
       ```json
       "depends": {
         "satin": "*"
       }
       ```
  </action>
  <verify>
    Run `./gradlew build` to verify compilation.
    Verify HudRenderCallback is properly registered.
  </verify>
  <done>
    - DownedHudOverlay displays MM:SS countdown timer
    - Timer color transitions yellow to red
    - "DOWNED" label shown above timer
    - All S2C packet receivers registered
    - Shader renders via PostWorldRenderCallback
    - Build succeeds
  </done>
</task>

</tasks>

<verification>
1. Run `JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" ./gradlew build`
2. Verify all shader files are valid
3. Verify DownedStateClientHandler integrates with Satin API
4. Verify HUD overlay registers correctly
5. Verify all packet receivers registered in DreadClient
</verification>

<success_criteria>
- Post-processing shader applies blur and vignette when downed
- Countdown timer displays on HUD with color interpolation
- Packet receivers handle state updates from server
- Effects clean up properly when RemoveDownedEffectsS2C received
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-death-revival-system/03-04-SUMMARY.md`
</output>
