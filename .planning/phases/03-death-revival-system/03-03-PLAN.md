---
phase: 03-death-revival-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/main/java/com/dread/death/DreadDeathHandler.java
  - src/main/java/com/dread/death/DeathCinematicController.java
  - src/main/java/com/dread/entity/DreadEntity.java
  - src/main/java/com/dread/DreadMod.java
  - src/client/java/com/dread/DreadClient.java
  - src/client/java/com/dread/client/DeathCinematicClientHandler.java
autonomous: true

must_haves:
  truths:
    - "Player killed by Dread enters downed state instead of dying"
    - "Death cinematic locks camera onto Dread entity for 4-5 seconds"
    - "Player health is set to 1.0 to prevent immediate death"
    - "Dread teleports face-to-face with player for cinematic kill"
  artifacts:
    - path: "src/main/java/com/dread/death/DreadDeathHandler.java"
      provides: "Death event interception and downed state transition"
      exports: ["register"]
    - path: "src/main/java/com/dread/death/DeathCinematicController.java"
      provides: "Server-side cinematic coordination"
      exports: ["triggerDeathCinematic"]
    - path: "src/client/java/com/dread/client/DeathCinematicClientHandler.java"
      provides: "Client-side camera lock and cinematic playback"
      exports: ["startCinematic", "tick", "endCinematic"]
  key_links:
    - from: "DreadDeathHandler"
      to: "ServerLivingEntityEvents.ALLOW_DEATH"
      via: "event registration"
      pattern: "ALLOW_DEATH\\.register"
    - from: "DreadDeathHandler"
      to: "DownedPlayersState.setDowned()"
      via: "state transition"
      pattern: "setDowned\\("
    - from: "DeathCinematicClientHandler"
      to: "MinecraftClient.setCameraEntity()"
      via: "camera lock"
      pattern: "setCameraEntity\\("
---

<objective>
Implement death event interception that cancels vanilla death when killed by Dread, transitions player to downed state, and triggers unskippable cinematic with camera locked onto Dread.

Purpose: Create the core death experience where players see their demise through a forced camera perspective before entering downed state.

Output:
- Death event handler that intercepts Dread kills
- Camera lock onto Dread during 4-5 second cinematic
- Dread teleports face-to-face for the kill shot
- Player transitions to downed state after cinematic
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-death-revival-system/03-RESEARCH.md
@.planning/phases/03-death-revival-system/03-CONTEXT.md

# Dependencies
@.planning/phases/03-death-revival-system/03-01-SUMMARY.md
@.planning/phases/03-death-revival-system/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create death event handler with downed state transition</name>
  <files>
    src/main/java/com/dread/death/DreadDeathHandler.java
    src/main/java/com/dread/death/DeathCinematicController.java
    src/main/java/com/dread/DreadMod.java
  </files>
  <action>
    1. Create DreadDeathHandler.java - intercepts death from Dread entity:
       ```java
       package com.dread.death;

       import com.dread.entity.DreadEntity;
       import com.dread.network.DreadNetworking;
       import com.dread.network.packets.CinematicTriggerS2C;
       import com.dread.sound.ModSounds;
       import net.fabricmc.fabric.api.entity.event.v1.ServerLivingEntityEvents;
       import net.fabricmc.fabric.api.networking.v1.ServerPlayNetworking;
       import net.minecraft.entity.Entity;
       import net.minecraft.entity.damage.DamageSource;
       import net.minecraft.server.network.ServerPlayerEntity;
       import net.minecraft.server.world.ServerWorld;

       /**
        * Intercepts player death from Dread and transitions to downed state.
        * Uses ServerLivingEntityEvents.ALLOW_DEATH which fires BEFORE totem processing.
        */
       public class DreadDeathHandler {

           public static void register() {
               ServerLivingEntityEvents.ALLOW_DEATH.register((entity, damageSource, damageAmount) -> {
                   // Only intercept player deaths
                   if (!(entity instanceof ServerPlayerEntity player)) {
                       return true;  // Allow non-player deaths
                   }

                   // Only intercept deaths caused by Dread entity
                   Entity attacker = damageSource.getAttacker();
                   if (!(attacker instanceof DreadEntity dread)) {
                       return true;  // Allow deaths from other sources
                   }

                   // Check if player is already downed (prevent re-triggering)
                   ServerWorld world = player.getServerWorld();
                   DownedPlayersState state = DownedPlayersState.getOrCreate(world);
                   if (state.isDowned(player)) {
                       return true;  // Already downed, allow actual death
                   }

                   // Cancel death and transition to downed state
                   player.setHealth(1.0f);  // Prevent death next tick

                   // Set player as downed
                   state.setDowned(player);

                   // Trigger death cinematic
                   DeathCinematicController.triggerDeathCinematic(player, dread);

                   return false;  // Cancel death
               });
           }
       }
       ```

    2. Create DeathCinematicController.java - server-side cinematic coordination:
       ```java
       package com.dread.death;

       import com.dread.entity.DreadEntity;
       import com.dread.network.packets.CinematicTriggerS2C;
       import com.dread.sound.ModSounds;
       import net.fabricmc.fabric.api.networking.v1.ServerPlayNetworking;
       import net.minecraft.server.network.ServerPlayerEntity;
       import net.minecraft.sound.SoundCategory;
       import net.minecraft.util.math.Vec3d;

       /**
        * Coordinates death cinematic sequence from server side.
        */
       public class DeathCinematicController {

           /**
            * Trigger death cinematic for a player killed by Dread.
            * Teleports Dread face-to-face and sends S2C packet for camera lock.
            */
           public static void triggerDeathCinematic(ServerPlayerEntity player, DreadEntity dread) {
               // Teleport Dread face-to-face with player (per CONTEXT.md - instant, no approach)
               Vec3d playerPos = player.getPos();
               Vec3d lookDir = player.getRotationVec(1.0f);

               // Position Dread 1.5 blocks in front of player, facing them
               Vec3d dreadPos = playerPos.add(lookDir.multiply(1.5));
               dread.refreshPositionAndAngles(
                   dreadPos.x,
                   playerPos.y,  // Same Y level
                   dreadPos.z,
                   player.getYaw() + 180,  // Face the player
                   0  // Level pitch
               );

               // Play death sound at player location
               player.getWorld().playSound(
                   null,  // All players can hear
                   player.getBlockPos(),
                   ModSounds.DREAD_DEATH,
                   SoundCategory.HOSTILE,
                   1.0f,
                   1.0f
               );

               // Send cinematic trigger to client
               ServerPlayNetworking.send(player, new CinematicTriggerS2C(
                   dread.getId(),
                   player.getBlockPos()
               ));

               // Note: Cinematic duration (4-5 seconds) is handled client-side
               // After cinematic, client applies downed state effects
           }
       }
       ```

    3. Register DreadDeathHandler in DreadMod.onInitialize():
       ```java
       DreadDeathHandler.register();
       ```
       Add after existing registrations.
  </action>
  <verify>
    Run `./gradlew build` to verify compilation.
    Verify DreadMod.java calls DreadDeathHandler.register().
  </verify>
  <done>
    - DreadDeathHandler intercepts Dread kills via ALLOW_DEATH event
    - Player health set to 1.0, death canceled
    - DownedPlayersState.setDowned() called
    - DeathCinematicController teleports Dread and sends S2C packet
    - Death sound plays
    - DreadMod registers the handler
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side cinematic handler with camera lock</name>
  <files>
    src/client/java/com/dread/client/DeathCinematicClientHandler.java
    src/client/java/com/dread/DreadClient.java
  </files>
  <action>
    1. Create DeathCinematicClientHandler.java - client-side camera control:
       ```java
       package com.dread.client;

       import com.dread.network.packets.CinematicTriggerS2C;
       import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
       import net.minecraft.client.MinecraftClient;
       import net.minecraft.entity.Entity;

       /**
        * Client-side handler for death cinematic.
        * Locks camera onto Dread entity for 4-5 seconds, then transitions to downed state.
        */
       public class DeathCinematicClientHandler {

           private static final int CINEMATIC_DURATION_TICKS = 90;  // 4.5 seconds

           private static boolean inCinematic = false;
           private static int cinematicTicks = 0;
           private static Entity originalCameraEntity = null;
           private static int dreadEntityId = -1;

           /**
            * Start death cinematic - called when receiving CinematicTriggerS2C packet.
            */
           public static void startCinematic(CinematicTriggerS2C payload) {
               MinecraftClient client = MinecraftClient.getInstance();
               if (client.world == null || client.player == null) return;

               // Find Dread entity by ID
               Entity dread = client.world.getEntityById(payload.dreadEntityId());
               if (dread == null) {
                   // Entity not found, skip cinematic but apply downed effects
                   DownedStateClientHandler.applyDownedEffects();
                   return;
               }

               // Store original camera entity (player)
               originalCameraEntity = client.getCameraEntity();
               dreadEntityId = payload.dreadEntityId();

               // Lock camera to Dread
               client.setCameraEntity(dread);

               // Start cinematic timer
               inCinematic = true;
               cinematicTicks = 0;
           }

           /**
            * Tick the cinematic - called every client tick.
            */
           public static void tick() {
               if (!inCinematic) return;

               MinecraftClient client = MinecraftClient.getInstance();
               if (client.world == null) {
                   endCinematic();
                   return;
               }

               cinematicTicks++;

               // Check if Dread entity still exists
               Entity dread = client.world.getEntityById(dreadEntityId);
               if (dread == null) {
                   // Dread despawned, end cinematic early
                   endCinematic();
                   return;
               }

               // Check if cinematic duration complete
               if (cinematicTicks >= CINEMATIC_DURATION_TICKS) {
                   endCinematic();
               }
           }

           /**
            * End cinematic and transition to downed state visuals.
            */
           public static void endCinematic() {
               MinecraftClient client = MinecraftClient.getInstance();

               // Restore camera to player
               if (originalCameraEntity != null) {
                   client.setCameraEntity(originalCameraEntity);
               } else if (client.player != null) {
                   client.setCameraEntity(client.player);
               }

               // Reset state
               inCinematic = false;
               cinematicTicks = 0;
               originalCameraEntity = null;
               dreadEntityId = -1;

               // Apply downed state visual effects (blur, vignette, timer)
               DownedStateClientHandler.applyDownedEffects();
           }

           /**
            * Check if currently in death cinematic.
            */
           public static boolean isInCinematic() {
               return inCinematic;
           }

           /**
            * Register tick event for cinematic updates.
            */
           public static void register() {
               ClientTickEvents.END_CLIENT_TICK.register(client -> tick());
           }
       }
       ```

    2. Create placeholder DownedStateClientHandler.java for now (full implementation in 03-04):
       ```java
       package com.dread.client;

       /**
        * Handles client-side downed state visual effects.
        * Full implementation in Plan 03-04.
        */
       public class DownedStateClientHandler {

           private static boolean isLocalPlayerDowned = false;

           public static void applyDownedEffects() {
               isLocalPlayerDowned = true;
               // TODO: Apply blur/vignette shaders (Plan 03-04)
               // TODO: Show countdown timer HUD (Plan 03-04)
           }

           public static void removeDownedEffects() {
               isLocalPlayerDowned = false;
               // TODO: Remove shaders (Plan 03-04)
               // TODO: Hide timer HUD (Plan 03-04)
           }

           public static boolean isLocalPlayerDowned() {
               return isLocalPlayerDowned;
           }
       }
       ```

    3. Update DreadClient.java to register cinematic handler and packet receiver:
       ```java
       // In onInitializeClient(), after entity renderer registration:

       // Register death cinematic handler
       DeathCinematicClientHandler.register();

       // Register packet receiver for cinematic trigger
       ClientPlayNetworking.registerGlobalReceiver(
           CinematicTriggerS2C.ID,
           (payload, context) -> {
               context.client().execute(() -> {
                   DeathCinematicClientHandler.startCinematic(payload);
               });
           }
       );
       ```

       Add imports:
       ```java
       import com.dread.client.DeathCinematicClientHandler;
       import com.dread.network.packets.CinematicTriggerS2C;
       import net.fabricmc.fabric.api.client.networking.v1.ClientPlayNetworking;
       ```
  </action>
  <verify>
    Run `./gradlew build` to verify all client classes compile.
    Verify DreadClient.java registers packet receiver.
  </verify>
  <done>
    - DeathCinematicClientHandler locks camera for 4.5 seconds
    - Camera is restored to player after cinematic
    - Packet receiver triggers cinematic on client
    - DownedStateClientHandler placeholder created for Plan 03-04
    - Client tick event registered for cinematic updates
  </done>
</task>

</tasks>

<verification>
1. Run `JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" ./gradlew build`
2. Verify all death/cinematic classes compile
3. Verify DreadMod.java registers DreadDeathHandler
4. Verify DreadClient.java registers packet receiver and tick event
</verification>

<success_criteria>
- Death from Dread is intercepted, player enters downed state instead
- Camera locks onto Dread for 4.5 seconds during cinematic
- Dread teleports face-to-face with player
- Death sound plays on kill
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-death-revival-system/03-03-SUMMARY.md`
</output>
