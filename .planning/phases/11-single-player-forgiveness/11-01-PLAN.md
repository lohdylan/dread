---
phase: 11-single-player-forgiveness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dread/death/GameModeDetector.java
  - src/main/java/com/dread/death/DownedPlayerData.java
  - src/main/java/com/dread/death/DownedPlayersState.java
  - src/main/java/com/dread/config/DreadConfig.java
autonomous: true

must_haves:
  truths:
    - "Single-player downed timer is 30 seconds (configurable)"
    - "Multiplayer downed timer is 300 seconds (configurable)"
    - "Game mode (SP vs MP) is detected when player enters downed state"
    - "Dedicated servers are always detected as multiplayer"
    - "Integrated server with 2+ players is detected as multiplayer"
  artifacts:
    - path: "src/main/java/com/dread/death/GameModeDetector.java"
      provides: "SP/MP mode detection utility"
      exports: ["detectMode", "DreadGameMode"]
    - path: "src/main/java/com/dread/death/DownedPlayerData.java"
      provides: "Mode storage in downed data"
      contains: "DreadGameMode mode"
    - path: "src/main/java/com/dread/config/DreadConfig.java"
      provides: "Separate timeout config options"
      contains: "singleplayer_timeout"
  key_links:
    - from: "src/main/java/com/dread/death/DownedPlayersState.java"
      to: "GameModeDetector"
      via: "detectMode() call in setDowned()"
      pattern: "GameModeDetector\\.detectMode"
---

<objective>
Implement game mode detection infrastructure and add mode-aware timeout configuration.

Purpose: Establish the foundation for differential single-player vs multiplayer behavior by detecting game mode at downed entry time and storing it with the player's downed state.

Output: GameModeDetector utility class, extended DownedPlayerData with mode field, config options for separate timeouts, and mode-aware setDowned() logic.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-single-player-forgiveness/11-CONTEXT.md
@.planning/phases/11-single-player-forgiveness/11-RESEARCH.md

Key existing files:
@src/main/java/com/dread/death/DownedPlayerData.java
@src/main/java/com/dread/death/DownedPlayersState.java
@src/main/java/com/dread/config/DreadConfig.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GameModeDetector utility and DreadGameMode enum</name>
  <files>src/main/java/com/dread/death/GameModeDetector.java</files>
  <action>
Create a new utility class GameModeDetector with:

1. Add DreadGameMode enum inside the class with values: SINGLEPLAYER, MULTIPLAYER

2. Add static method detectMode(ServerWorld world) that returns DreadGameMode:
   - If server.isSingleplayer() returns false -> return MULTIPLAYER (dedicated server)
   - If server.getPlayerManager().getCurrentPlayerCount() == 1 -> return SINGLEPLAYER
   - Otherwise -> return MULTIPLAYER (LAN or multiple players)

3. Add static method isSingleplayerMode(ServerWorld world) boolean helper for convenience

Import net.minecraft.server.MinecraftServer and net.minecraft.server.world.ServerWorld.

AVOID: Don't use reflection to check for LAN status. Don't cache mode globally - it must be checked per-downed instance.
  </action>
  <verify>
File compiles without errors:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>GameModeDetector.java exists with detectMode() method that correctly identifies dedicated servers as MULTIPLAYER and true singleplayer (integrated server with 1 player) as SINGLEPLAYER</done>
</task>

<task type="auto">
  <name>Task 2: Extend DownedPlayerData with mode field and NBT serialization</name>
  <files>src/main/java/com/dread/death/DownedPlayerData.java</files>
  <action>
Extend DownedPlayerData to store game mode:

1. Add import for GameModeDetector.DreadGameMode

2. Add public field: public DreadGameMode mode;

3. Update constructor DownedPlayerData(UUID, BlockPos, int) to add DreadGameMode parameter:
   - DownedPlayerData(UUID playerId, BlockPos downedPos, int remainingTicks, DreadGameMode mode)
   - Assign this.mode = mode

4. Update NBT constructor to read mode:
   - Read mode from nbt.getString("Mode"), default to MULTIPLAYER if not present (backwards compatibility)
   - Use DreadGameMode.valueOf() with try-catch, fallback to MULTIPLAYER

5. Update toNbt() to write mode:
   - nbt.putString("Mode", mode.name())

IMPORTANT: The DreadGameMode enum is inside GameModeDetector as GameModeDetector.DreadGameMode.
  </action>
  <verify>
File compiles without errors:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>DownedPlayerData has mode field, updated constructor signature, and NBT read/write for mode persistence</done>
</task>

<task type="auto">
  <name>Task 3: Add config options and update DownedPlayersState.setDowned()</name>
  <files>
    src/main/java/com/dread/config/DreadConfig.java
    src/main/java/com/dread/death/DownedPlayersState.java
  </files>
  <action>
1. In DreadConfig.java, add two new fields after existing config fields:
   - public int singleplayerDownedTimeout = 30;  // 30 seconds for singleplayer
   - public int multiplayerDownedTimeout = 300;  // 300 seconds for multiplayer (existing default)

   Add comment field:
   - @SerializedName("_comment_timeouts")
   - public final String comment_timeouts = "singleplayerDownedTimeout: Seconds in downed state before death in singleplayer (normal respawn). multiplayerDownedTimeout: Seconds in multiplayer before permanent spectator.";

2. In DownedPlayersState.java:
   - Add import for GameModeDetector and DreadGameMode
   - Add import for DreadConfigLoader
   - Remove or comment out the static DOWNED_DURATION_TICKS constant (no longer hardcoded)

   Update setDowned(ServerPlayerEntity player) method:
   - Detect mode using GameModeDetector.detectMode(player.getServerWorld())
   - Get config via DreadConfigLoader.getConfig()
   - Calculate timeout in ticks based on mode:
     - SINGLEPLAYER: config.singleplayerDownedTimeout * 20
     - MULTIPLAYER: config.multiplayerDownedTimeout * 20
   - Create DownedPlayerData with the new constructor that includes mode:
     new DownedPlayerData(playerId, pos, timeoutTicks, mode)

AVOID: Don't remove the DOWNED_DURATION_TICKS constant completely if it's referenced elsewhere - check first.
  </action>
  <verify>
Build succeeds and config loads:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>Config has separate timeout options, DownedPlayersState.setDowned() detects mode and uses mode-appropriate timeout</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew build`
2. GameModeDetector.detectMode() exists and returns correct enum values
3. DownedPlayerData stores mode and serializes to/from NBT
4. DreadConfig has singleplayerDownedTimeout and multiplayerDownedTimeout fields
5. setDowned() uses mode-based timeout calculation
</verification>

<success_criteria>
- GameModeDetector utility class created with DreadGameMode enum
- DownedPlayerData extended with mode field and NBT persistence
- Config has separate timeout options (30s SP, 300s MP defaults)
- setDowned() detects mode and applies correct timer
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-single-player-forgiveness/11-01-SUMMARY.md`
</output>
