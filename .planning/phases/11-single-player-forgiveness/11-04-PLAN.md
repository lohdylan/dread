---
phase: 11-single-player-forgiveness
plan: 04
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/client/java/com/dread/client/DownedStateClientHandler.java
  - src/client/java/com/dread/client/DownedHudOverlay.java
  - src/client/java/com/dread/DreadClient.java
autonomous: true

must_haves:
  truths:
    - "HUD displays 'MERCY' text in orange when in singleplayer mode"
    - "HUD displays 'NO MERCY' text in red when in multiplayer mode"
    - "Timer color is orange/amber in singleplayer, red in multiplayer"
    - "Mode indicator updates when mercy mode changes (live)"
  artifacts:
    - path: "src/client/java/com/dread/client/DownedStateClientHandler.java"
      provides: "Client-side mercy mode storage"
      contains: "isMercyMode"
    - path: "src/client/java/com/dread/client/DownedHudOverlay.java"
      provides: "Mode indicator and colored timer UI"
      contains: "MERCY"
  key_links:
    - from: "src/client/java/com/dread/client/DownedHudOverlay.java"
      to: "DownedStateClientHandler"
      via: "isMercyMode() check in render"
      pattern: "DownedStateClientHandler\\.isMercyMode"
---

<objective>
Implement client-side UI updates for mercy mode indicator and timer color changes.

Purpose: Players need visual feedback showing whether they're in MERCY mode (singleplayer, shorter timer, normal respawn) or NO MERCY mode (multiplayer, long timer, permanent death). This affects timer color and adds a mode indicator label.

Output: DownedStateClientHandler storing mercy mode, DownedHudOverlay rendering mode text and colored timer.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-single-player-forgiveness/11-CONTEXT.md
@.planning/phases/11-single-player-forgiveness/11-RESEARCH.md

Key existing files:
@src/client/java/com/dread/client/DownedStateClientHandler.java
@src/client/java/com/dread/client/DownedHudOverlay.java
@src/client/java/com/dread/DreadClient.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mercy mode storage to DownedStateClientHandler</name>
  <files>src/client/java/com/dread/client/DownedStateClientHandler.java</files>
  <action>
Extend DownedStateClientHandler to track mercy mode:

1. Add a new static field:
   private static boolean isMercyMode = false;

2. Update applyDownedEffects(int remainingTime) to accept mercy mode:
   Create overloaded method:
   public static void applyDownedEffects(int remainingTime, boolean mercyMode) {
       isDownedEffectActive = true;
       remainingSeconds = remainingTime;
       isMercyMode = mercyMode;

       if (ShaderCompatibilityDetector.shouldDisablePostProcessing()) {
           LOGGER.info("Applied downed state ({}s remaining, {}) - shader effects disabled for compatibility",
               remainingTime, mercyMode ? "MERCY" : "NO MERCY");
       } else {
           LOGGER.info("Applied downed state effects ({}s remaining, {})",
               remainingTime, mercyMode ? "MERCY" : "NO MERCY");
       }
   }

   Keep the original applyDownedEffects(int remainingTime) method but have it call:
   applyDownedEffects(remainingTime, false); // Default to NO MERCY

3. Update removeDownedEffects() to also reset mercy mode:
   isMercyMode = false;

4. Add getter method:
   public static boolean isMercyMode() {
       return isMercyMode;
   }

5. Add method to update mercy mode (for live mode transitions):
   public static void setMercyMode(boolean mercyMode) {
       isMercyMode = mercyMode;
   }
  </action>
  <verify>
File compiles without errors:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>DownedStateClientHandler stores isMercyMode and has getter/setter methods</done>
</task>

<task type="auto">
  <name>Task 2: Update DreadClient to pass mercy mode to handler</name>
  <files>src/client/java/com/dread/DreadClient.java</files>
  <action>
Update the DownedStateUpdateS2C packet handler to pass mercy mode:

1. Find the packet handler for DownedStateUpdateS2C (should be in onInitializeClient)

2. Update the handler to pass isMercyMode to DownedStateClientHandler:

   The handler should call:
   DownedStateClientHandler.applyDownedEffects(remainingSeconds, isMercyMode);

   Example updated handler:
   ClientPlayNetworking.registerGlobalReceiver(DownedStateUpdateS2C.ID, (payload, context) -> {
       boolean isDowned = payload.isDowned();
       int remainingSeconds = payload.remainingSeconds();
       boolean isMercyMode = payload.isMercyMode();

       context.client().execute(() -> {
           if (isDowned) {
               DownedStateClientHandler.applyDownedEffects(remainingSeconds, isMercyMode);
               DownedStateClientHandler.updateCountdown(remainingSeconds);
           } else {
               DownedStateClientHandler.removeDownedEffects();
           }
       });
   });

NOTE: Also update updateCountdown calls to pass the mercy mode if needed, or just set mercy mode separately via setMercyMode().
  </action>
  <verify>
Build succeeds:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>DreadClient passes isMercyMode from packet to DownedStateClientHandler</done>
</task>

<task type="auto">
  <name>Task 3: Update DownedHudOverlay to display mode indicator and colored timer</name>
  <files>src/client/java/com/dread/client/DownedHudOverlay.java</files>
  <action>
Modify DownedHudOverlay to show MERCY/NO MERCY indicator and use mode-specific colors:

1. Add new color constants at the top of the class:
   private static final int COLOR_ORANGE = 0xFFFFAA00;  // Minecraft Gold/Orange for MERCY
   // Keep existing COLOR_YELLOW and COLOR_RED

2. Modify renderDownedHud() method to add mode indicator and use mode-specific colors:

   Replace the current "DOWNED" label rendering with:

   // Mode indicator - above the DOWNED label
   boolean isMercy = DownedStateClientHandler.isMercyMode();
   String modeText = isMercy ? "MERCY" : "NO MERCY";
   int modeColor = isMercy ? COLOR_ORANGE : COLOR_RED;

   int modeWidth = client.textRenderer.getWidth(modeText);
   drawContext.drawText(
       client.textRenderer,
       modeText,
       centerX - modeWidth / 2,
       centerY - 50,  // Above DOWNED label
       modeColor,
       true // shadow
   );

   // Keep "DOWNED" label but use mode-appropriate color
   String downedLabel = "DOWNED";
   int labelWidth = client.textRenderer.getWidth(downedLabel);
   drawContext.drawText(
       client.textRenderer,
       downedLabel,
       centerX - labelWidth / 2,
       centerY - 30,
       modeColor,  // Use mode color instead of always red
       true // shadow
   );

3. Update timer color calculation:

   Change the timer color logic to use mode-specific coloring:

   int timerColor;
   if (isMercy) {
       // MERCY mode: orange throughout (no dramatic color change)
       timerColor = COLOR_ORANGE;
   } else {
       // NO MERCY mode: yellow to red gradient based on time remaining
       // Assuming max time is 300 seconds (5 minutes)
       float timeRatio = remainingSeconds / 300.0f;
       timerColor = interpolateColor(COLOR_YELLOW, COLOR_RED, 1.0f - timeRatio);
   }

   This makes MERCY mode visually distinct (solid orange) while NO MERCY has the dramatic color transition.

CONTEXT DECISION: "Mode text uses same red horror styling as existing downed text" - but MERCY mode uses orange/amber. "When in MERCY mode, both text and timer are orange/amber colored"
  </action>
  <verify>
Build succeeds:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew build --quiet
```
  </verify>
  <done>HUD shows "MERCY" (orange) or "NO MERCY" (red) indicator with mode-appropriate timer colors</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew build`
2. DownedStateClientHandler stores and exposes isMercyMode
3. DreadClient passes mercy mode from packet to handler
4. HUD displays "MERCY" in orange when singleplayer, "NO MERCY" in red when multiplayer
5. Timer is orange in MERCY mode, yellow-to-red gradient in NO MERCY mode
6. "DOWNED" label uses mode-appropriate color
</verification>

<success_criteria>
- Client handler stores mercy mode from server packets
- HUD renders mode indicator ("MERCY" or "NO MERCY")
- MERCY mode uses orange color scheme throughout
- NO MERCY mode uses red color scheme with yellow-red timer gradient
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-single-player-forgiveness/11-04-SUMMARY.md`
</output>
