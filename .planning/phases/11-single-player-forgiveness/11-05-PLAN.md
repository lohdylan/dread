---
phase: 11-single-player-forgiveness
plan: 05
type: execute
wave: 3
depends_on: ["11-01", "11-02"]
files_modified:
  - src/main/java/com/dread/death/PlayerConnectionHandler.java
  - src/main/java/com/dread/death/DownedPlayersState.java
  - src/main/java/com/dread/config/DreadConfig.java
autonomous: true

must_haves:
  truths:
    - "Player joining while someone is downed triggers SP to MP mode transition"
    - "Last player leaving triggers MP to SP mode transition for remaining downed player"
    - "Timer scales proportionally when mode transitions"
    - "Respawn debuff (Weakness II 60s, Slowness I 30s) applied after singleplayer Dread death"
  artifacts:
    - path: "src/main/java/com/dread/death/PlayerConnectionHandler.java"
      provides: "Mode transition handling on join/leave"
      contains: "transitionToMultiplayer"
    - path: "src/main/java/com/dread/death/DownedPlayersState.java"
      provides: "Mode transition methods with timer scaling"
      contains: "transitionToSingleplayer"
  key_links:
    - from: "src/main/java/com/dread/death/PlayerConnectionHandler.java"
      to: "DownedPlayersState"
      via: "transitionTo methods on player events"
      pattern: "state\\.transitionTo"
---

<objective>
Implement mid-downed mode transitions and singleplayer respawn debuff.

Purpose: When a second player joins (SP to MP) or the last other player leaves (MP to SP), the downed player's mode and timer should update accordingly. Also apply Weakness + Slowness debuff when player respawns after singleplayer Dread death.

Output: Mode transition methods in DownedPlayersState, updated PlayerConnectionHandler for join/leave events, respawn debuff application.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-single-player-forgiveness/11-CONTEXT.md
@.planning/phases/11-single-player-forgiveness/11-RESEARCH.md

Key existing files:
@src/main/java/com/dread/death/PlayerConnectionHandler.java
@src/main/java/com/dread/death/DownedPlayersState.java
@src/main/java/com/dread/config/DreadConfig.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode transition methods to DownedPlayersState</name>
  <files>src/main/java/com/dread/death/DownedPlayersState.java</files>
  <action>
Add methods for transitioning downed players between modes:

1. Add import for DreadConfigLoader if not present:
   import com.dread.config.DreadConfigLoader;

2. Add transitionToMultiplayer method:
   /**
    * Transition a downed player from SINGLEPLAYER to MULTIPLAYER mode.
    * Scales remaining timer proportionally to the new max.
    */
   public void transitionToMultiplayer(UUID playerId) {
       DownedPlayerData data = downedPlayers.get(playerId);
       if (data == null || data.mode != GameModeDetector.DreadGameMode.SINGLEPLAYER) {
           return; // Not downed or already in multiplayer
       }

       var config = DreadConfigLoader.getConfig();
       int spMaxTicks = config.singleplayerDownedTimeout * 20;
       int mpMaxTicks = config.multiplayerDownedTimeout * 20;

       // Proportional scaling: maintain percentage of time remaining
       float timeRatio = (float) data.remainingTicks / spMaxTicks;
       int newRemaining = Math.max(1, (int) (timeRatio * mpMaxTicks));

       data.remainingTicks = newRemaining;
       data.mode = GameModeDetector.DreadGameMode.MULTIPLAYER;
       markDirty();
   }

3. Add transitionToSingleplayer method:
   /**
    * Transition a downed player from MULTIPLAYER to SINGLEPLAYER mode.
    * Scales remaining timer proportionally to the new max.
    */
   public void transitionToSingleplayer(UUID playerId) {
       DownedPlayerData data = downedPlayers.get(playerId);
       if (data == null || data.mode != GameModeDetector.DreadGameMode.MULTIPLAYER) {
           return; // Not downed or already in singleplayer
       }

       var config = DreadConfigLoader.getConfig();
       int mpMaxTicks = config.multiplayerDownedTimeout * 20;
       int spMaxTicks = config.singleplayerDownedTimeout * 20;

       // Proportional scaling: maintain percentage of time remaining
       float timeRatio = (float) data.remainingTicks / mpMaxTicks;
       int newRemaining = Math.max(1, (int) (timeRatio * spMaxTicks));

       data.remainingTicks = newRemaining;
       data.mode = GameModeDetector.DreadGameMode.SINGLEPLAYER;
       markDirty();
   }

NOTE: Proportional scaling means if player has 50% time left in SP (15s/30s), they get 50% of MP time (150s/300s). This prevents exploits where players game the mode switching.
  </action>
  <verify>
File compiles without errors:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>DownedPlayersState has transitionToMultiplayer() and transitionToSingleplayer() methods with proportional timer scaling</done>
</task>

<task type="auto">
  <name>Task 2: Update PlayerConnectionHandler for mode transitions and respawn debuff</name>
  <files>src/main/java/com/dread/death/PlayerConnectionHandler.java</files>
  <action>
Update PlayerConnectionHandler to handle mode transitions and apply respawn debuff:

1. Add imports:
   import com.dread.death.GameModeDetector;
   import com.dread.death.GameModeDetector.DreadGameMode;
   import net.minecraft.entity.effect.StatusEffectInstance;
   import net.minecraft.entity.effect.StatusEffects;
   import net.fabricmc.fabric.api.entity.event.v1.ServerPlayerEvents;

2. In register() method, add respawn event handler:
   ServerPlayerEvents.AFTER_RESPAWN.register(PlayerConnectionHandler::onPlayerRespawn);

3. Update onPlayerJoin() to check for mode transitions:
   After the existing escaped player handling, add:

   // Check if any downed players need mode transition (SP -> MP)
   // This happens when a second player joins (LAN or dedicated)
   for (DownedPlayerData data : state.getAllDowned()) {
       if (data.mode == DreadGameMode.SINGLEPLAYER) {
           DreadMod.LOGGER.info("Player joined, transitioning downed player {} to MULTIPLAYER mode",
               data.playerId);
           state.transitionToMultiplayer(data.playerId);
       }
   }

4. Update onPlayerDisconnect() to check for mode transitions:
   After the existing escaped player handling, add check for MP -> SP transition:

   // Check if we need to transition downed players to SINGLEPLAYER mode
   // This happens when the last other player leaves
   int remainingPlayers = server.getPlayerManager().getCurrentPlayerCount() - 1; // -1 for disconnecting player
   if (remainingPlayers == 1 && server.isSingleplayer()) {
       // Only one player left in integrated server - check for downed players to transition
       for (DownedPlayerData data : state.getAllDowned()) {
           if (data.mode == DreadGameMode.MULTIPLAYER) {
               DreadMod.LOGGER.info("Last other player left, transitioning downed player {} to SINGLEPLAYER mode",
                   data.playerId);
               state.transitionToSingleplayer(data.playerId);
           }
       }
   }

5. Add new method for respawn debuff:
   /**
    * Handle player respawn - apply debuff if player died from Dread in singleplayer.
    */
   private static void onPlayerRespawn(ServerPlayerEntity oldPlayer, ServerPlayerEntity newPlayer, boolean alive) {
       // Only handle death respawns (alive = false means respawning from death, true means returning from End)
       if (alive) return;

       ServerWorld world = newPlayer.getServerWorld();
       DownedPlayersState state = DownedPlayersState.getOrCreate(world);

       // Check if player just respawned from Dread death
       if (state.hadRecentDreadDeath(newPlayer.getUuid())) {
           DreadMod.LOGGER.info("Player {} respawned from Dread death - applying debuffs",
               newPlayer.getName().getString());

           // Apply Weakness II for 60 seconds
           newPlayer.addStatusEffect(new StatusEffectInstance(
               StatusEffects.WEAKNESS,
               20 * 60,  // 60 seconds
               1,        // Amplifier 1 = Weakness II
               false,    // isAmbient
               true      // showParticles
           ));

           // Apply Slowness I for 30 seconds
           newPlayer.addStatusEffect(new StatusEffectInstance(
               StatusEffects.SLOWNESS,
               20 * 30,  // 30 seconds
               0,        // Amplifier 0 = Slowness I
               false,    // isAmbient
               true      // showParticles
           ));

           // Clear the flag so debuff isn't applied again
           state.clearDreadDeathFlag(newPlayer.getUuid());
       }
   }

NOTE: The 'alive' parameter in AFTER_RESPAWN is true when returning from the End, false when respawning from death. We only want to apply debuffs on death respawn.
  </action>
  <verify>
Build succeeds:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>PlayerConnectionHandler handles SP<->MP mode transitions on join/leave and applies respawn debuffs after singleplayer Dread death</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew build`
2. Player joining triggers SP to MP transition for downed players
3. Last player leaving triggers MP to SP transition for downed players
4. Timer scales proportionally during mode transitions
5. Respawn from Dread death in singleplayer applies Weakness II (60s) + Slowness I (30s)
6. Respawn debuff only applies once per Dread death
</verification>

<success_criteria>
- transitionToMultiplayer() and transitionToSingleplayer() methods exist
- Timer scaling uses proportional formula
- PlayerConnectionHandler triggers transitions on join/leave
- Respawn debuff applied via ServerPlayerEvents.AFTER_RESPAWN
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-single-player-forgiveness/11-05-SUMMARY.md`
</output>
