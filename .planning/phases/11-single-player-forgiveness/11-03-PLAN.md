---
phase: 11-single-player-forgiveness
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/main/java/com/dread/network/packets/DownedStateUpdateS2C.java
  - src/main/java/com/dread/death/DreadDeathManager.java
  - src/main/java/com/dread/network/DreadNetworking.java
  - src/client/java/com/dread/DreadClient.java
autonomous: true

must_haves:
  truths:
    - "DownedStateUpdateS2C packet includes mercy mode boolean"
    - "Client receives mercy mode flag with each downed state sync"
    - "Server sends correct mercy mode based on stored game mode"
  artifacts:
    - path: "src/main/java/com/dread/network/packets/DownedStateUpdateS2C.java"
      provides: "Extended packet with mercy mode"
      contains: "isMercyMode"
    - path: "src/client/java/com/dread/DreadClient.java"
      provides: "Updated packet handler for new format"
      contains: "isMercyMode"
  key_links:
    - from: "src/main/java/com/dread/death/DreadDeathManager.java"
      to: "DownedStateUpdateS2C"
      via: "packet creation in syncDownedStates"
      pattern: "new DownedStateUpdateS2C.*isMercyMode"
---

<objective>
Extend the DownedStateUpdateS2C packet to include mercy mode flag for client-side UI rendering.

Purpose: The client needs to know whether the player is in MERCY (singleplayer) or NO MERCY (multiplayer) mode to display the correct UI colors and mode indicator.

Output: Extended packet with isMercyMode boolean, updated server sync to include mode, updated client handler to extract mode.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-single-player-forgiveness/11-CONTEXT.md
@.planning/phases/11-single-player-forgiveness/11-RESEARCH.md

Key existing files:
@src/main/java/com/dread/network/packets/DownedStateUpdateS2C.java
@src/main/java/com/dread/death/DreadDeathManager.java
@src/main/java/com/dread/network/DreadNetworking.java
@src/client/java/com/dread/DreadClient.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DownedStateUpdateS2C packet with mercy mode flag</name>
  <files>src/main/java/com/dread/network/packets/DownedStateUpdateS2C.java</files>
  <action>
Modify the record to include mercy mode:

1. Update the record definition to add isMercyMode parameter:
   public record DownedStateUpdateS2C(boolean isDowned, int remainingSeconds, boolean isMercyMode) implements CustomPayload

2. Update the CODEC to include the new field:
   public static final PacketCodec<RegistryByteBuf, DownedStateUpdateS2C> CODEC =
       PacketCodec.tuple(
           PacketCodecs.BOOL, DownedStateUpdateS2C::isDowned,
           PacketCodecs.VAR_INT, DownedStateUpdateS2C::remainingSeconds,
           PacketCodecs.BOOL, DownedStateUpdateS2C::isMercyMode,
           DownedStateUpdateS2C::new
       );

The record automatically gets the isMercyMode() accessor method.

NOTE: isMercyMode = true means SINGLEPLAYER (MERCY mode), false means MULTIPLAYER (NO MERCY mode)
  </action>
  <verify>
File compiles without errors:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>DownedStateUpdateS2C record has isMercyMode field and updated CODEC</done>
</task>

<task type="auto">
  <name>Task 2: Update server sync to include mercy mode in packet</name>
  <files>src/main/java/com/dread/death/DreadDeathManager.java</files>
  <action>
Modify syncDownedStates() to include mercy mode in packet:

1. Add import if not already present:
   import com.dread.death.GameModeDetector.DreadGameMode;

2. In syncDownedStates(), update the packet creation to include isMercyMode:

   Find this section:
   for (DownedPlayerData data : state.getAllDowned()) {
       ServerPlayerEntity player = world.getServer().getPlayerManager().getPlayer(data.playerId);
       if (player != null) {
           DownedStateUpdateS2C packet = new DownedStateUpdateS2C(
               true,
               data.getRemainingSeconds()
           );
           ServerPlayNetworking.send(player, packet);
       }
   }

   Update packet creation to:
   DownedStateUpdateS2C packet = new DownedStateUpdateS2C(
       true,
       data.getRemainingSeconds(),
       data.mode == DreadGameMode.SINGLEPLAYER  // isMercyMode
   );

This ensures the packet includes the correct mercy mode flag based on the player's stored game mode.
  </action>
  <verify>
Build succeeds:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>syncDownedStates() sends DownedStateUpdateS2C with isMercyMode derived from DownedPlayerData.mode</done>
</task>

<task type="auto">
  <name>Task 3: Update client packet handler for new packet format</name>
  <files>src/client/java/com/dread/DreadClient.java</files>
  <action>
Update the client-side packet handler to receive and store mercy mode:

1. First read the existing DreadClient.java to understand the current packet handling structure

2. Find where DownedStateUpdateS2C is handled (likely in onInitializeClient or a registered handler)

3. Update the handler to extract isMercyMode from the packet:
   - The packet now has packet.isMercyMode() accessor
   - Pass this to DownedStateClientHandler (will be implemented in next plan)

For now, just extract the value. Example handler update:
   ClientPlayNetworking.registerGlobalReceiver(DownedStateUpdateS2C.ID, (payload, context) -> {
       boolean isDowned = payload.isDowned();
       int remainingSeconds = payload.remainingSeconds();
       boolean isMercyMode = payload.isMercyMode();

       context.client().execute(() -> {
           if (isDowned) {
               DownedStateClientHandler.applyDownedEffects(remainingSeconds);
               // TODO: Pass isMercyMode to client handler (implemented in Plan 04)
           } else {
               DownedStateClientHandler.removeDownedEffects();
           }
       });
   });

NOTE: The actual use of isMercyMode will be added in Plan 04 when we update DownedStateClientHandler. For now, just ensure the packet handler compiles with the new parameter extraction.
  </action>
  <verify>
Build succeeds:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && cd "X:/Vibe Coding" && ./gradlew classes --quiet
```
  </verify>
  <done>Client packet handler extracts isMercyMode from DownedStateUpdateS2C packet</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew build`
2. DownedStateUpdateS2C has isMercyMode field in record
3. Server sends isMercyMode based on player's stored game mode
4. Client handler extracts isMercyMode (usage in next plan)
</verification>

<success_criteria>
- DownedStateUpdateS2C record extended with isMercyMode boolean
- CODEC updated to serialize/deserialize the new field
- Server sync sends correct mercy mode per player
- Client handler receives and extracts mercy mode
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-single-player-forgiveness/11-03-SUMMARY.md`
</output>
