---
phase: 08-cinematic-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/java/com/dread/client/CameraShakeHandler.java
  - src/main/java/com/dread/config/DreadConfig.java
  - src/client/java/com/dread/client/DeathCinematicClientHandler.java
autonomous: true

must_haves:
  truths:
    - "Camera shakes during death cinematic with random jolts"
    - "Shake intensity configurable via cameraShakeIntensity (0-100)"
    - "Shake uses exponential decay for smooth frame-rate-independent feel"
    - "Setting intensity to 0 disables shake but cinematic still plays"
  artifacts:
    - path: "src/client/java/com/dread/client/CameraShakeHandler.java"
      provides: "Exponential decay camera shake logic"
      min_lines: 50
    - path: "src/main/java/com/dread/config/DreadConfig.java"
      provides: "cameraShakeIntensity config option"
      contains: "cameraShakeIntensity"
    - path: "src/client/java/com/dread/client/DeathCinematicClientHandler.java"
      provides: "Camera shake integration during cinematic"
      contains: "CameraShakeHandler"
  key_links:
    - from: "DeathCinematicClientHandler.java"
      to: "CameraShakeHandler.java"
      via: "startShake() and tick() calls"
      pattern: "cameraShake\\."
    - from: "DeathCinematicClientHandler.java"
      to: "DreadConfig.java"
      via: "Config intensity lookup"
      pattern: "cameraShakeIntensity"
---

<objective>
Implement camera shake system with exponential decay, configurable intensity slider, and integration into death cinematic.

Purpose: Add visceral camera shake during the death grab to enhance horror impact, with accessibility options for motion-sensitive players.

Output: New CameraShakeHandler class, config option for shake intensity, integrated shake in cinematic handler.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-cinematic-enhancement/08-RESEARCH.md
@.planning/phases/08-cinematic-enhancement/08-CONTEXT.md
@src/client/java/com/dread/client/DeathCinematicClientHandler.java
@src/main/java/com/dread/config/DreadConfig.java
@src/main/java/com/dread/config/DreadConfigLoader.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CameraShakeHandler with exponential decay</name>
  <files>src/client/java/com/dread/client/CameraShakeHandler.java</files>
  <action>
Create a new client-side class for camera shake with exponential smoothing (frame-rate independent).

Key constants:
- SHAKE_MAGNITUDE = 2.5f (degrees - subtle but noticeable per CONTEXT.md)
- DECAY_SPEED = 8.0f (medium decay for 0.7-1s feel per CONTEXT.md)

Implementation following research pattern:
```java
package com.dread.client;

import java.util.Random;

/**
 * Camera shake handler using exponential decay for smooth, frame-rate independent shake.
 * Used during death cinematic for visceral impact.
 */
public class CameraShakeHandler {
    private static final float SHAKE_MAGNITUDE = 2.5f; // degrees (subtle but noticeable)
    private static final float DECAY_SPEED = 8.0f;     // medium decay (0.7-1s feel)

    private float currentYaw = 0.0f;
    private float currentPitch = 0.0f;
    private float targetYaw = 0.0f;
    private float targetPitch = 0.0f;
    private boolean isActive = false;
    private final Random random = new Random();

    /**
     * Start camera shake with given intensity multiplier (0.0 to 1.0).
     * Creates sharp violent jolts in random directions.
     */
    public void startShake(float intensity) {
        if (intensity <= 0.0f) {
            return; // Shake disabled via config
        }

        // Pure chaos direction - random in all directions
        targetYaw = (random.nextFloat() - 0.5f) * 2.0f * SHAKE_MAGNITUDE * intensity;
        targetPitch = (random.nextFloat() - 0.5f) * 2.0f * SHAKE_MAGNITUDE * intensity;
        currentYaw = 0.0f;
        currentPitch = 0.0f;
        isActive = true;
    }

    /**
     * Update shake state using exponential decay.
     * Call once per tick during cinematic.
     *
     * @param deltaTime Time since last tick in seconds (typically 0.05 for 20 TPS)
     */
    public void tick(float deltaTime) {
        if (!isActive) return;

        // Exponential decay formula - frame-rate independent
        // Source: https://lisyarus.github.io/blog/posts/exponential-smoothing.html
        float decay = 1.0f - (float)Math.exp(-DECAY_SPEED * deltaTime);
        currentYaw += (targetYaw - currentYaw) * decay;
        currentPitch += (targetPitch - currentPitch) * decay;

        // Decay target toward zero (returns to normal)
        float targetDecay = (float)Math.exp(-DECAY_SPEED * deltaTime);
        targetYaw *= targetDecay;
        targetPitch *= targetDecay;

        // Stop when negligible (prevent floating point drift)
        if (Math.abs(currentYaw) < 0.01f && Math.abs(currentPitch) < 0.01f &&
            Math.abs(targetYaw) < 0.01f && Math.abs(targetPitch) < 0.01f) {
            reset();
        }
    }

    /**
     * Reset all shake state. Call when cinematic ends.
     */
    public void reset() {
        currentYaw = 0.0f;
        currentPitch = 0.0f;
        targetYaw = 0.0f;
        targetPitch = 0.0f;
        isActive = false;
    }

    /**
     * Get yaw offset to add to camera rotation.
     */
    public float getYawOffset() {
        return currentYaw;
    }

    /**
     * Get pitch offset to add to camera rotation.
     */
    public float getPitchOffset() {
        return currentPitch;
    }

    /**
     * Check if shake is currently active.
     */
    public boolean isActive() {
        return isActive;
    }
}
```
  </action>
  <verify>
Verify CameraShakeHandler.java exists with:
1. SHAKE_MAGNITUDE and DECAY_SPEED constants
2. startShake() method accepting intensity
3. tick() method with exponential decay formula
4. reset() method
5. getYawOffset() and getPitchOffset() methods
  </verify>
  <done>
CameraShakeHandler class created with exponential decay, random direction jolts, and intensity support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cameraShakeIntensity config option</name>
  <files>src/main/java/com/dread/config/DreadConfig.java</files>
  <action>
Add the camera shake intensity slider (0-100%) to the config file:

1. Add the config field after existing feature toggles:
```java
// Camera shake intensity (0 = disabled, 100 = full horror)
public int cameraShakeIntensity = 100;
```

2. Add documentation comment:
```java
@SerializedName("_comment_shake")
public final String comment4 = "cameraShakeIntensity: Camera shake strength during death cinematic (0-100). Set to 0 to disable shake while keeping cinematic. Lower values boost visual compensation effects.";
```

The default is 100 (full horror) per CONTEXT.md decision: "Default: 100% full horror - they can reduce if needed"

Note: Config values are already validated in DreadConfigLoader, but we should ensure the value is clamped to 0-100 when used.
  </action>
  <verify>
Verify DreadConfig.java contains:
1. cameraShakeIntensity field with default value 100
2. Comment explaining the 0-100 range and purpose
  </verify>
  <done>
Config option added for camera shake intensity with 0-100 range and 100% default
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate camera shake into DeathCinematicClientHandler</name>
  <files>src/client/java/com/dread/client/DeathCinematicClientHandler.java</files>
  <action>
Modify the existing DeathCinematicClientHandler to include camera shake during the cinematic.

1. Add imports:
```java
import com.dread.config.DreadConfigLoader;
```

2. Add static CameraShakeHandler instance:
```java
private static final CameraShakeHandler cameraShake = new CameraShakeHandler();
```

3. In startCinematic(), trigger shake after setting up the cinematic:
```java
// After cinematicActive = true; cinematicTimer = 0;
// Get shake intensity from config (0-100 -> 0.0-1.0)
var config = DreadConfigLoader.getConfig();
float intensity = Math.clamp(config.cameraShakeIntensity, 0, 100) / 100.0f;
cameraShake.startShake(intensity);
```

4. Modify tick() to update shake and apply to camera:
```java
private static void tick() {
    cinematicTimer++;

    MinecraftClient client = MinecraftClient.getInstance();
    Entity cameraEntity = client.getCameraEntity();
    if (cameraEntity == null) return;

    // Update shake (deltaTime = 1 tick = 0.05 seconds)
    cameraShake.tick(0.05f);

    // Apply shake offset to camera entity rotation
    if (cameraShake.isActive()) {
        float baseYaw = cameraEntity.getYaw();
        float basePitch = cameraEntity.getPitch();
        cameraEntity.setYaw(baseYaw + cameraShake.getYawOffset());
        cameraEntity.setPitch(basePitch + cameraShake.getPitchOffset());
    }

    if (cinematicTimer >= CINEMATIC_DURATION_TICKS) {
        endCinematic();
    }
}
```

5. In endCinematic(), reset shake BEFORE restoring camera:
```java
private static void endCinematic() {
    MinecraftClient client = MinecraftClient.getInstance();

    // CRITICAL: Reset shake before ending
    cameraShake.reset();

    // Restore camera to original entity (player)
    if (originalCameraEntity != null) {
        client.setCameraEntity(originalCameraEntity);
        originalCameraEntity = null;
    }
    // ... rest of existing code
}
```

Note: The CINEMATIC_DURATION_TICKS will need to be updated in Plan 08-03 to match the new 1.8s animation (36 ticks instead of 90).
  </action>
  <verify>
Verify DeathCinematicClientHandler.java:
1. Has CameraShakeHandler instance
2. startCinematic() reads config and calls startShake()
3. tick() calls cameraShake.tick() and applies offsets
4. endCinematic() calls cameraShake.reset()
  </verify>
  <done>
Camera shake integrated into death cinematic - shakes during grab, respects config intensity, properly resets on end
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the project:
```bash
export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && ./gradlew build
```

2. Verify all classes compile without errors

3. Check that CameraShakeHandler is referenced in DeathCinematicClientHandler

4. Verify config field exists in DreadConfig
</verification>

<success_criteria>
- Build succeeds without errors
- CameraShakeHandler class exists with exponential decay implementation
- DreadConfig has cameraShakeIntensity (default 100)
- DeathCinematicClientHandler integrates shake on cinematic start
- Shake resets properly when cinematic ends
- Setting cameraShakeIntensity to 0 disables shake but cinematic still plays
</success_criteria>

<output>
After completion, create `.planning/phases/08-cinematic-enhancement/08-02-SUMMARY.md`
</output>
