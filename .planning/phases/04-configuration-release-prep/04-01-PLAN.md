---
phase: 04-configuration-release-prep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dread/config/DreadConfig.java
  - src/main/java/com/dread/config/DreadConfigLoader.java
  - src/main/java/com/dread/DreadMod.java
autonomous: true

must_haves:
  truths:
    - "Config file dread.json exists in config directory after first launch"
    - "Config values load correctly from file on mod initialization"
    - "Invalid config values are clamped to valid ranges without crashing"
  artifacts:
    - path: "src/main/java/com/dread/config/DreadConfig.java"
      provides: "Config data class with all configurable fields"
      contains: "baseSpawnChancePerSecond"
    - path: "src/main/java/com/dread/config/DreadConfigLoader.java"
      provides: "Singleton loader with validation and GSON serialization"
      exports: ["load", "getConfig"]
  key_links:
    - from: "src/main/java/com/dread/DreadMod.java"
      to: "DreadConfigLoader.load()"
      via: "First call in onInitialize()"
      pattern: "DreadConfigLoader\\.load\\(\\)"
---

<objective>
Create GSON-based configuration system with all configurable fields.

Purpose: Establish the foundation for all user-configurable settings using bundled GSON library. Config loads first in mod initialization to ensure values available for all features.
Output: DreadConfig data class, DreadConfigLoader singleton, config loading in DreadMod
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-release-prep/04-RESEARCH.md
@src/main/java/com/dread/DreadMod.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DreadConfig data class</name>
  <files>src/main/java/com/dread/config/DreadConfig.java</files>
  <action>
Create config data class with public fields and sensible defaults:

```java
package com.dread.config;

import com.google.gson.annotations.SerializedName;

public class DreadConfig {
    // Spawn configuration (from Phase 2 tuning)
    public float baseSpawnChancePerSecond = 0.005f; // 0.5% per second
    public float miningBonusPerBlock = 0.001f;      // +0.1% per block mined
    public int dayEscalationCap = 20;              // Max day for multiplier

    // Damage configuration
    public float dreadAttackDamage = 20.0f;        // One-shot kill (10 hearts)

    // Feature toggles
    public boolean modEnabled = true;
    public boolean skipDeathCinematic = false;     // Cinematic plays by default
    public boolean disableDownedEffects = false;   // Force disable blur/vignette

    // Documentation fields (appear as comments in JSON)
    @SerializedName("_comment_spawn")
    public final String comment1 = "baseSpawnChancePerSecond: Base probability per tick (0.005 = 0.5%). miningBonusPerBlock: Added per block mined. dayEscalationCap: Max world day for multiplier.";

    @SerializedName("_comment_damage")
    public final String comment2 = "dreadAttackDamage: Damage dealt by Dread (20.0 = instant kill for 20 HP players).";

    @SerializedName("_comment_features")
    public final String comment3 = "modEnabled: Master toggle. skipDeathCinematic: Skip 4.5s death camera lock. disableDownedEffects: Force disable blur/vignette shaders.";
}
```

Use @SerializedName for comment fields to create pseudo-documentation in generated JSON.
  </action>
  <verify>File compiles without errors: `./gradlew compileJava --console=plain 2>&1 | tail -20`</verify>
  <done>DreadConfig.java exists with all 7 configurable fields and 3 comment fields</done>
</task>

<task type="auto">
  <name>Task 2: Create DreadConfigLoader singleton</name>
  <files>src/main/java/com/dread/config/DreadConfigLoader.java</files>
  <action>
Create singleton loader with validation and GSON serialization:

```java
package com.dread.config;

import com.dread.DreadMod;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import net.fabricmc.loader.api.FabricLoader;

import java.io.Reader;
import java.io.Writer;
import java.nio.file.Files;
import java.nio.file.Path;

public class DreadConfigLoader {
    private static final Gson GSON = new GsonBuilder()
        .setPrettyPrinting()
        .serializeNulls()
        .disableHtmlEscaping()
        .create();

    private static DreadConfig instance;

    public static DreadConfig load() {
        if (instance != null) return instance;

        Path configPath = FabricLoader.getInstance().getConfigDir().resolve("dread.json");

        if (Files.exists(configPath)) {
            try (Reader reader = Files.newBufferedReader(configPath)) {
                instance = GSON.fromJson(reader, DreadConfig.class);
                if (instance == null) {
                    instance = new DreadConfig();
                }
                validate();
                save(); // Write back clamped values
                DreadMod.LOGGER.info("Loaded config from {}", configPath);
            } catch (Exception e) {
                DreadMod.LOGGER.error("Failed to load config, using defaults", e);
                instance = new DreadConfig();
                save();
            }
        } else {
            instance = new DreadConfig();
            save(); // Create default config
            DreadMod.LOGGER.info("Created default config at {}", configPath);
        }

        return instance;
    }

    public static DreadConfig getConfig() {
        if (instance == null) {
            return load();
        }
        return instance;
    }

    private static void validate() {
        // Clamp spawn rates (0.0 to 1.0)
        instance.baseSpawnChancePerSecond = Math.max(0.0f, Math.min(1.0f, instance.baseSpawnChancePerSecond));
        instance.miningBonusPerBlock = Math.max(0.0f, Math.min(0.1f, instance.miningBonusPerBlock));
        instance.dayEscalationCap = Math.max(1, Math.min(100, instance.dayEscalationCap));

        // Clamp damage (0.0 to 100.0)
        instance.dreadAttackDamage = Math.max(0.0f, Math.min(100.0f, instance.dreadAttackDamage));
    }

    private static void save() {
        Path configPath = FabricLoader.getInstance().getConfigDir().resolve("dread.json");
        try (Writer writer = Files.newBufferedWriter(configPath)) {
            GSON.toJson(instance, writer);
        } catch (Exception e) {
            DreadMod.LOGGER.error("Failed to save config", e);
        }
    }
}
```

Key implementation notes:
- Singleton pattern with null check
- GSON with pretty printing for readable JSON
- Validation clamps ALL numeric values to valid ranges
- Save after validation to persist clamped values
- Use FabricLoader.getInstance().getConfigDir() for standard config location
  </action>
  <verify>File compiles without errors: `./gradlew compileJava --console=plain 2>&1 | tail -20`</verify>
  <done>DreadConfigLoader.java exists with load(), getConfig(), validate(), and save() methods</done>
</task>

<task type="auto">
  <name>Task 3: Load config first in DreadMod.onInitialize()</name>
  <files>src/main/java/com/dread/DreadMod.java</files>
  <action>
Modify DreadMod to load config as the FIRST operation in onInitialize():

1. Add import: `import com.dread.config.DreadConfigLoader;`

2. In onInitialize(), add config loading as first line after logger message:
```java
@Override
public void onInitialize() {
    LOGGER.info("Initializing Dread mod...");

    // Load config FIRST before any other initialization
    DreadConfigLoader.load();

    // ... rest of existing initialization
    ModSounds.register();
    ModEntities.register();
    // etc.
}
```

This ensures config values are available to all subsequent feature registrations.
  </action>
  <verify>Build succeeds: `./gradlew build --console=plain 2>&1 | tail -30`</verify>
  <done>DreadMod.onInitialize() calls DreadConfigLoader.load() as first initialization step</done>
</task>

</tasks>

<verification>
1. Build compiles successfully: `./gradlew build`
2. Config files exist: `src/main/java/com/dread/config/DreadConfig.java` and `DreadConfigLoader.java`
3. DreadMod imports and calls config loader
</verification>

<success_criteria>
- DreadConfig.java defines all 7 configurable fields (spawn rate, mining bonus, day cap, damage, mod enabled, skip cinematic, disable effects)
- DreadConfigLoader.java implements singleton loading with GSON, validation, and save
- DreadMod.onInitialize() loads config before any other initialization
- Build succeeds with no compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-release-prep/04-01-SUMMARY.md`
</output>
