---
phase: 04-configuration-release-prep
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/main/java/com/dread/spawn/DreadSpawnManager.java
  - src/main/java/com/dread/entity/DreadEntity.java
  - src/main/java/com/dread/death/DreadDeathHandler.java
  - src/main/java/com/dread/death/DeathCinematicController.java
autonomous: true

must_haves:
  truths:
    - "Setting modEnabled=false disables all Dread spawning and features"
    - "Spawn probability uses config baseSpawnChancePerSecond instead of hardcoded 0.005f"
    - "Dread attack damage uses config dreadAttackDamage value"
    - "Setting skipDeathCinematic=true bypasses 4.5s camera lock"
  artifacts:
    - path: "src/main/java/com/dread/spawn/DreadSpawnManager.java"
      provides: "Config-driven spawn probability"
      contains: "DreadConfigLoader.getConfig()"
    - path: "src/main/java/com/dread/death/DeathCinematicController.java"
      provides: "Config-driven cinematic skip"
      contains: "skipDeathCinematic"
  key_links:
    - from: "src/main/java/com/dread/spawn/DreadSpawnManager.java"
      to: "DreadConfigLoader"
      via: "Config value read in evaluateSpawnProbability"
      pattern: "getConfig\\(\\)"
---

<objective>
Integrate configuration values into spawn, damage, and cinematic systems.

Purpose: Replace hardcoded values with config-driven behavior to enable user customization of mod experience.
Output: DreadSpawnManager uses config spawn rates, DreadEntity uses config damage, DreadDeathHandler respects mod toggle, DeathCinematicController supports skip option
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-release-prep/04-01-SUMMARY.md
@src/main/java/com/dread/spawn/DreadSpawnManager.java
@src/main/java/com/dread/entity/DreadEntity.java
@src/main/java/com/dread/death/DreadDeathHandler.java
@src/main/java/com/dread/death/DeathCinematicController.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate config into DreadSpawnManager</name>
  <files>src/main/java/com/dread/spawn/DreadSpawnManager.java</files>
  <action>
Modify DreadSpawnManager to use config values:

1. Add import: `import com.dread.config.DreadConfigLoader;`

2. In evaluateSpawnProbability(), add modEnabled check at start:
```java
private static void evaluateSpawnProbability(ServerWorld world) {
    // Check if mod is enabled
    if (!DreadConfigLoader.getConfig().modEnabled) {
        return; // Skip all spawn logic when mod disabled
    }

    // ... rest of existing code
}
```

3. In calculateSpawnChance(), replace hardcoded values with config:
```java
private static float calculateSpawnChance(SpawnProbabilityState state,
                                          ServerPlayerEntity player,
                                          ServerWorld world) {
    var config = DreadConfigLoader.getConfig();

    long worldDay = world.getTimeOfDay() / 24000L;
    int blocksMined = state.getMinedBlocks(player.getUuid());

    // Use config values instead of hardcoded
    float baseChance = config.baseSpawnChancePerSecond;

    // Day escalation: Linear scaling up to config cap
    float dayMultiplier = 1.0f + Math.min(worldDay, config.dayEscalationCap) * 0.5f;

    // Mining bonus from config
    float miningBonus = blocksMined * config.miningBonusPerBlock;

    float totalChance = (baseChance * dayMultiplier) + miningBonus;

    return totalChance;
}
```

This replaces:
- `0.005f` with `config.baseSpawnChancePerSecond`
- `20` day cap with `config.dayEscalationCap`
- `0.001f` mining bonus with `config.miningBonusPerBlock`
  </action>
  <verify>File compiles: `./gradlew compileJava --console=plain 2>&1 | tail -20`</verify>
  <done>DreadSpawnManager uses config.baseSpawnChancePerSecond, config.miningBonusPerBlock, config.dayEscalationCap, and respects config.modEnabled</done>
</task>

<task type="auto">
  <name>Task 2: Integrate config into damage and death systems</name>
  <files>
    src/main/java/com/dread/death/DreadDeathHandler.java
    src/main/java/com/dread/death/DeathCinematicController.java
  </files>
  <action>
**DreadDeathHandler.java:**

1. Add import: `import com.dread.config.DreadConfigLoader;`

2. Add modEnabled check at start of onPlayerDeath():
```java
private static boolean onPlayerDeath(LivingEntity entity, DamageSource source, float damageAmount) {
    // Check if mod is enabled
    if (!DreadConfigLoader.getConfig().modEnabled) {
        return true; // Allow vanilla death when mod disabled
    }

    // Only handle player deaths
    if (!(entity instanceof ServerPlayerEntity player)) {
        return true;
    }
    // ... rest of existing code
}
```

**DeathCinematicController.java:**

1. Add import: `import com.dread.config.DreadConfigLoader;`

2. Modify triggerDeathCinematic() to check skipDeathCinematic:
```java
public static void triggerDeathCinematic(ServerPlayerEntity player, DreadEntity dread) {
    var config = DreadConfigLoader.getConfig();

    // Skip cinematic if configured
    if (config.skipDeathCinematic) {
        // Still play death sound, but no camera lock
        BlockPos deathPos = player.getBlockPos();
        player.getServerWorld().playSound(
            null,
            deathPos,
            ModSounds.DREAD_DEATH,
            SoundCategory.HOSTILE,
            1.0f,
            1.0f
        );
        return; // Skip rest of cinematic
    }

    // ... rest of existing cinematic code (teleport Dread, send packet)
}
```

When skipDeathCinematic=true:
- Death sound still plays (audio feedback)
- Dread NOT teleported face-to-face
- No CinematicTriggerS2C packet sent (no camera lock)
- Player transitions directly to downed state
  </action>
  <verify>Files compile: `./gradlew compileJava --console=plain 2>&1 | tail -20`</verify>
  <done>DreadDeathHandler respects modEnabled, DeathCinematicController respects skipDeathCinematic</done>
</task>

<task type="auto">
  <name>Task 3: Configure Dread attack damage</name>
  <files>src/main/java/com/dread/entity/DreadEntity.java</files>
  <action>
Create attribute-based damage configuration for DreadEntity.

1. Add import: `import com.dread.config.DreadConfigLoader;`

2. Override tryAttack() to use config damage:
```java
@Override
public boolean tryAttack(Entity target) {
    var config = DreadConfigLoader.getConfig();

    // Skip attack if mod disabled
    if (!config.modEnabled) {
        return false;
    }

    // Apply configured damage
    float damage = config.dreadAttackDamage;

    if (target instanceof LivingEntity living) {
        living.damage(this.getDamageSources().mobAttack(this), damage);
        return true;
    }

    return super.tryAttack(target);
}
```

3. Add required import: `import net.minecraft.entity.Entity;` (if not already present)
4. Add required import: `import net.minecraft.entity.LivingEntity;` (should be present via PathAwareEntity)

This overrides the default MeleeAttackGoal damage to use config value instead of entity attributes.
  </action>
  <verify>Build succeeds: `./gradlew build --console=plain 2>&1 | tail -30`</verify>
  <done>DreadEntity.tryAttack() uses config.dreadAttackDamage and respects config.modEnabled</done>
</task>

</tasks>

<verification>
1. Build compiles successfully: `./gradlew build`
2. DreadSpawnManager imports DreadConfigLoader and uses config values
3. DreadDeathHandler checks modEnabled before processing deaths
4. DeathCinematicController checks skipDeathCinematic before camera lock
5. DreadEntity uses config damage in tryAttack()
</verification>

<success_criteria>
- modEnabled=false prevents all Dread spawning and death interception
- Spawn probability uses config.baseSpawnChancePerSecond, config.miningBonusPerBlock, config.dayEscalationCap
- skipDeathCinematic=true bypasses camera lock but plays death sound
- Attack damage uses config.dreadAttackDamage
- Build succeeds with no compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-release-prep/04-02-SUMMARY.md`
</output>
