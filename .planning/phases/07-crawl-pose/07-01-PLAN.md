---
phase: 07-crawl-pose
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dread/death/DreadDeathHandler.java
  - src/main/java/com/dread/death/RevivalInteractionHandler.java
  - src/main/java/com/dread/death/DreadDeathManager.java
  - src/main/java/com/dread/death/CrawlPoseHandler.java
  - src/client/java/com/dread/mixin/PlayerPoseMixin.java
  - src/main/resources/dread.mixins.json
autonomous: true

must_haves:
  truths:
    - "Player visually enters prone/crawling pose when entering downed state"
    - "Pose persists across ticks without flickering"
    - "Other players see downed player in crawling pose"
    - "Pose resets to standing when revived"
    - "Pose resets to standing when transitioning to spectator"
  artifacts:
    - path: "src/main/java/com/dread/death/CrawlPoseHandler.java"
      provides: "Server-side pose management (enter/exit crawl pose)"
      exports: ["enterCrawlPose", "exitCrawlPose"]
    - path: "src/client/java/com/dread/mixin/PlayerPoseMixin.java"
      provides: "Client-side pose override mixin to prevent vanilla pose resets"
      contains: "forceSwimmingPoseWhenDowned"
  key_links:
    - from: "src/main/java/com/dread/death/DreadDeathHandler.java"
      to: "CrawlPoseHandler.enterCrawlPose"
      via: "method call when player enters downed state"
      pattern: "CrawlPoseHandler\\.enterCrawlPose"
    - from: "src/main/java/com/dread/death/RevivalInteractionHandler.java"
      to: "CrawlPoseHandler.exitCrawlPose"
      via: "method call when player is revived"
      pattern: "CrawlPoseHandler\\.exitCrawlPose"
    - from: "src/client/java/com/dread/mixin/PlayerPoseMixin.java"
      to: "DownedStateClientHandler.isDownedEffectActive"
      via: "client-side downed state check"
      pattern: "isDownedEffectActive"
---

<objective>
Implement core crawl pose system that makes players enter prone/swimming pose when downed and syncs correctly across multiplayer.

Purpose: This is the foundation for Phase 7 - without the pose override working, none of the visual polish matters. The pose must persist across ticks and sync to all clients.

Output: CrawlPoseHandler class for server-side pose management, PlayerPoseMixin for client-side pose persistence, integration into existing death/revival flow.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crawl-pose/07-CONTEXT.md
@.planning/phases/07-crawl-pose/07-RESEARCH.md
@src/main/java/com/dread/death/DreadDeathHandler.java
@src/main/java/com/dread/death/RevivalInteractionHandler.java
@src/main/java/com/dread/death/DreadDeathManager.java
@src/main/java/com/dread/death/DownedPlayersState.java
@src/client/java/com/dread/client/DownedStateClientHandler.java
@src/client/java/com/dread/mixin/ClientAttackMixin.java
@src/main/resources/dread.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrawlPoseHandler server-side utility</name>
  <files>src/main/java/com/dread/death/CrawlPoseHandler.java</files>
  <action>
Create CrawlPoseHandler.java in the death package with two static methods:

1. `enterCrawlPose(ServerPlayerEntity player)`:
   - Call `player.setPose(EntityPose.SWIMMING)` to set prone pose
   - Log pose change at debug level
   - EntityPose is from `net.minecraft.entity.EntityPose`

2. `exitCrawlPose(ServerPlayerEntity player)`:
   - Call `player.setPose(EntityPose.STANDING)` to reset to normal pose
   - Log pose change at debug level

Keep the class simple - just pose setting. The DataTracker handles sync automatically.
  </action>
  <verify>File compiles without errors when building the project</verify>
  <done>CrawlPoseHandler.java exists with enterCrawlPose() and exitCrawlPose() methods</done>
</task>

<task type="auto">
  <name>Task 2: Integrate pose changes into death/revival flow</name>
  <files>
src/main/java/com/dread/death/DreadDeathHandler.java
src/main/java/com/dread/death/RevivalInteractionHandler.java
src/main/java/com/dread/death/DreadDeathManager.java
  </files>
  <action>
Integrate CrawlPoseHandler calls at three critical points:

1. **DreadDeathHandler.onPlayerDeath()** - After line `RevivalInteractionHandler.applyMovementPenalty(player);`:
   - Add: `CrawlPoseHandler.enterCrawlPose(player);`
   - This sets prone pose when player enters downed state

2. **RevivalInteractionHandler.completeRevival()** - After line `removeMovementPenalty(downedPlayer);`:
   - Add: `CrawlPoseHandler.exitCrawlPose(downedPlayer);`
   - This resets pose when player is revived

3. **DreadDeathManager.transitionToSpectator()** - Before line `player.changeGameMode(GameMode.SPECTATOR);`:
   - Add: `CrawlPoseHandler.exitCrawlPose(player);`
   - This resets pose before spectator transition

Add import for CrawlPoseHandler in each file.
  </action>
  <verify>Build succeeds and pose methods are called in the correct order</verify>
  <done>CrawlPoseHandler integrated into all three entry/exit points for downed state</done>
</task>

<task type="auto">
  <name>Task 3: Create PlayerPoseMixin to prevent pose reset</name>
  <files>
src/client/java/com/dread/mixin/PlayerPoseMixin.java
src/main/resources/dread.mixins.json
  </files>
  <action>
Create client-side mixin to prevent vanilla from resetting the swimming pose.

**PlayerPoseMixin.java** in `src/client/java/com/dread/mixin/PlayerPoseMixin.java`:

```java
package com.dread.mixin;

import com.dread.client.DownedStateClientHandler;
import net.minecraft.entity.EntityPose;
import net.minecraft.entity.player.PlayerEntity;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

/**
 * Client-side mixin that maintains swimming/crawling pose when player is downed.
 * Prevents vanilla updatePose() from resetting pose based on water/sneaking state.
 */
@Mixin(PlayerEntity.class)
public class PlayerPoseMixin {

    @Inject(method = "updatePose", at = @At("HEAD"), cancellable = true)
    private void dread$forceSwimmingPoseWhenDowned(CallbackInfo ci) {
        // Only apply on client side when downed effects are active
        if (DownedStateClientHandler.isDownedEffectActive()) {
            PlayerEntity player = (PlayerEntity)(Object)this;
            player.setPose(EntityPose.SWIMMING);
            ci.cancel(); // Prevent vanilla pose logic from running
        }
    }
}
```

**Update dread.mixins.json** - Add "PlayerPoseMixin" to the "client" array:

```json
"client": [
    "DeathScreenMixin",
    "ClientAttackMixin",
    "PlayerPoseMixin"
]
```

Key points:
- Mixin targets PlayerEntity.updatePose() which runs every tick
- Uses DownedStateClientHandler.isDownedEffectActive() for state check (already exists)
- Cancels vanilla logic to prevent pose flickering
- Client-side only because server sets pose via DataTracker sync
  </action>
  <verify>
Build succeeds with mixin applied. Test in-game:
1. Get killed by Dread entity
2. Player should enter prone/swimming pose
3. Pose should persist without flickering
4. Get revived - pose should reset to standing
  </verify>
  <done>PlayerPoseMixin prevents pose reset, player maintains prone pose while downed</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   - `./gradlew build` succeeds with no errors
   - No mixin application errors in log

2. **Single-player test:**
   - Spawn Dread entity, let it kill you
   - Player should visibly enter prone/swimming pose
   - Camera should be at ground level
   - Pose persists while waiting for revival timer
   - Crouching friend revives you - pose resets to standing
   - Wait for timer to expire - pose resets before spectator mode

3. **Multiplayer test (if possible):**
   - Second player should see first player in prone pose when downed
   - Pose should sync correctly across clients
</verification>

<success_criteria>
- CrawlPoseHandler.java exists with enterCrawlPose/exitCrawlPose methods
- DreadDeathHandler calls enterCrawlPose when player is downed
- RevivalInteractionHandler calls exitCrawlPose when player is revived
- DreadDeathManager calls exitCrawlPose before spectator transition
- PlayerPoseMixin prevents vanilla pose reset while downed
- Player visually crawls (prone pose) when in downed state
- Pose resets to standing on revival or spectator transition
</success_criteria>

<output>
After completion, create `.planning/phases/07-crawl-pose/07-01-SUMMARY.md`
</output>
