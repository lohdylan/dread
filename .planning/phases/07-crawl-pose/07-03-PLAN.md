---
phase: 07-crawl-pose
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/client/java/com/dread/client/CrawlVignetteRenderer.java
  - src/client/java/com/dread/client/CrawlCameraHandler.java
  - src/main/java/com/dread/death/DreadDeathManager.java
  - src/client/java/com/dread/DreadClient.java
  - src/client/java/com/dread/mixin/CrawlCameraMixin.java
  - src/main/resources/dread.mixins.json
autonomous: true

must_haves:
  truths:
    - "Visual feedback reinforces wounded/helpless feeling through blood-red screen edges"
    - "Other players can see a downed player is injured through visible blood particles"
    - "Perspective feels grounded to surface - cannot look straight up while crawling"
    - "Entering downed state immediately creates visual urgency"
    - "Revival removes all wound indicators - player feels restored"
  artifacts:
    - path: "src/client/java/com/dread/client/CrawlVignetteRenderer.java"
      provides: "HUD overlay rendering blood vignette when downed"
      exports: ["register", "render"]
    - path: "src/client/java/com/dread/client/CrawlCameraHandler.java"
      provides: "Camera pitch limiting when downed"
      exports: ["register", "clampPitch"]
    - path: "src/client/java/com/dread/mixin/CrawlCameraMixin.java"
      provides: "Mixin to intercept camera rotation for pitch clamping"
      contains: "limitPitchWhenCrawling"
  key_links:
    - from: "src/client/java/com/dread/client/CrawlVignetteRenderer.java"
      to: "DownedStateClientHandler.isDownedEffectActive"
      via: "client-side downed state check"
      pattern: "isDownedEffectActive"
    - from: "src/main/java/com/dread/death/DreadDeathManager.java"
      to: "ParticleTypes.DRIPPING_LAVA"
      via: "server-side particle spawning"
      pattern: "spawnParticles"
---

<objective>
Add visual feedback for downed state: blood vignette overlay, blood drip particles, and camera pitch limiting.

Purpose: Visual feedback reinforces the "dying and need help" feeling. Blood vignette creates urgency, particles signal injury to other players, and limited camera pitch reinforces being on the ground.

Output: CrawlVignetteRenderer for HUD overlay, blood particles spawned server-side, CrawlCameraMixin for pitch limiting.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crawl-pose/07-CONTEXT.md
@.planning/phases/07-crawl-pose/07-RESEARCH.md
@.planning/phases/07-crawl-pose/07-01-SUMMARY.md
@src/client/java/com/dread/client/DownedStateClientHandler.java
@src/client/java/com/dread/client/DownedHudOverlay.java
@src/main/java/com/dread/death/DreadDeathManager.java
@src/client/java/com/dread/DreadClient.java
@src/main/resources/dread.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrawlVignetteRenderer for blood vignette overlay</name>
  <files>
src/client/java/com/dread/client/CrawlVignetteRenderer.java
src/client/java/com/dread/DreadClient.java
  </files>
  <action>
Create client-side HUD overlay that renders red blood vignette when downed.

**CrawlVignetteRenderer.java** in `src/client/java/com/dread/client/`:

```java
package com.dread.client;

import com.mojang.blaze3d.systems.RenderSystem;
import net.fabricmc.fabric.api.client.rendering.v1.HudRenderCallback;
import net.minecraft.client.MinecraftClient;
import net.minecraft.client.gui.DrawContext;
import net.minecraft.client.render.RenderTickCounter;
import net.minecraft.util.Identifier;

/**
 * Renders blood vignette overlay when player is downed.
 * Creates urgent "wounded and dying" visual feedback.
 */
public class CrawlVignetteRenderer {

    // Use vanilla vignette texture with red tint
    private static final Identifier VIGNETTE_TEXTURE =
        Identifier.ofVanilla("textures/misc/vignette.png");

    /**
     * Register with HudRenderCallback during client initialization.
     */
    public static void register() {
        HudRenderCallback.EVENT.register(CrawlVignetteRenderer::render);
    }

    /**
     * Render blood vignette overlay.
     */
    private static void render(DrawContext context, RenderTickCounter tickCounter) {
        // Only render when downed
        if (!DownedStateClientHandler.isDownedEffectActive()) {
            return;
        }

        MinecraftClient client = MinecraftClient.getInstance();
        int width = client.getWindow().getScaledWidth();
        int height = client.getWindow().getScaledHeight();

        // Enable blending for transparency
        RenderSystem.enableBlend();
        RenderSystem.defaultBlendFunc();

        // Set red tint with strong opacity (blood effect)
        RenderSystem.setShaderColor(1.0f, 0.15f, 0.15f, 0.65f);

        // Draw vignette texture covering full screen
        context.drawTexture(
            VIGNETTE_TEXTURE,
            0, 0,           // screen position
            0, 0,           // texture UV start
            width, height,  // render size
            width, height   // texture size (stretch to fit)
        );

        // Reset shader color to white
        RenderSystem.setShaderColor(1.0f, 1.0f, 1.0f, 1.0f);
        RenderSystem.disableBlend();
    }
}
```

**Update DreadClient.java** - Add CrawlVignetteRenderer registration after DownedHudOverlay:

Add import: `import com.dread.client.CrawlVignetteRenderer;`

In onInitializeClient(), after `DownedHudOverlay.register();` line, add:
```java
CrawlVignetteRenderer.register();
```

Key points:
- Uses vanilla vignette.png texture (no custom asset needed)
- Red tint (1.0, 0.15, 0.15) creates blood effect
- 0.65 opacity is strong but allows gameplay
- HudRenderCallback is deprecated but still functional; alternative HudElementRegistry requires more complex setup
  </action>
  <verify>Build succeeds, vignette renders when downed in-game</verify>
  <done>CrawlVignetteRenderer.java exists and registered, blood vignette visible when downed</done>
</task>

<task type="auto">
  <name>Task 2: Add blood drip particle spawning in DreadDeathManager</name>
  <files>src/main/java/com/dread/death/DreadDeathManager.java</files>
  <action>
Add server-side blood particle spawning for downed players.

**In DreadDeathManager.java**, add a new method and integrate it into the tick loop:

1. Add import at top:
```java
import net.minecraft.particle.ParticleTypes;
import net.minecraft.util.math.Vec3d;
```

2. Add new method after `syncDownedStates()`:

```java
/**
 * Spawn blood drip particles around downed players.
 * Visible to all nearby players, reinforcing injury state.
 */
private static void spawnBloodParticles(ServerWorld world, DownedPlayersState state) {
    // Only spawn particles every 10 ticks (0.5 seconds)
    if (world.getTime() % 10 != 0) return;

    for (DownedPlayerData data : state.getAllDowned()) {
        ServerPlayerEntity player = world.getServer().getPlayerManager().getPlayer(data.playerId);
        if (player == null) continue;

        Vec3d pos = player.getPos();

        // Spawn 1-2 particles around player at random offsets
        int particleCount = world.random.nextInt(2) + 1;
        for (int i = 0; i < particleCount; i++) {
            double offsetX = (world.random.nextDouble() - 0.5) * 0.6;
            double offsetZ = (world.random.nextDouble() - 0.5) * 0.6;

            world.spawnParticles(
                ParticleTypes.DRIPPING_LAVA,  // Red dripping particle
                pos.x + offsetX,
                pos.y + 0.3,  // Slightly above ground level
                pos.z + offsetZ,
                1,            // particle count
                0, 0, 0,      // no velocity spread
                0.0           // no extra speed
            );
        }
    }
}
```

3. In `tick()` method, add call to spawnBloodParticles after processActiveRevivals:

```java
// Spawn blood particles for downed players
spawnBloodParticles(world, state);
```

Key points:
- Uses ParticleTypes.DRIPPING_LAVA for red dripping effect
- Server-side spawning means all nearby players see particles
- Spawns every 0.5 seconds to avoid spam
- Random offset creates natural spread around player
  </action>
  <verify>Build succeeds, blood particles spawn around downed player visible to all clients</verify>
  <done>Blood drip particles spawn server-side around downed players</done>
</task>

<task type="auto">
  <name>Task 3: Create camera pitch limiting mixin</name>
  <files>
src/client/java/com/dread/mixin/CrawlCameraMixin.java
src/client/java/com/dread/client/CrawlCameraHandler.java
src/main/resources/dread.mixins.json
  </files>
  <action>
Create client-side mixin and handler to limit camera pitch when downed.

**CrawlCameraHandler.java** in `src/client/java/com/dread/client/`:

```java
package com.dread.client;

import net.minecraft.util.math.MathHelper;

/**
 * Handles camera pitch limiting when player is downed/crawling.
 * Reinforces the "on the ground" feeling by preventing looking straight up.
 */
public class CrawlCameraHandler {

    // Pitch limits when crawling (can't look straight up)
    // Vanilla range is -90 (up) to +90 (down)
    private static final float MIN_PITCH = -30.0f;  // Slightly above horizon
    private static final float MAX_PITCH = 90.0f;   // Full look down allowed

    /**
     * Clamp pitch value when player is downed.
     * @param pitch Original pitch value
     * @return Clamped pitch if downed, original otherwise
     */
    public static float clampPitchIfDowned(float pitch) {
        if (DownedStateClientHandler.isDownedEffectActive()) {
            return MathHelper.clamp(pitch, MIN_PITCH, MAX_PITCH);
        }
        return pitch;
    }
}
```

**CrawlCameraMixin.java** in `src/client/java/com/dread/mixin/`:

```java
package com.dread.mixin;

import com.dread.client.CrawlCameraHandler;
import net.minecraft.client.render.Camera;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

/**
 * Client-side mixin that limits camera pitch when player is downed.
 * Prevents looking straight up to reinforce ground-level crawling feeling.
 */
@Mixin(Camera.class)
public class CrawlCameraMixin {

    @Shadow
    private float pitch;

    @Inject(method = "setRotation", at = @At("TAIL"))
    private void dread$limitPitchWhenCrawling(float yaw, float pitch, CallbackInfo ci) {
        // Clamp pitch after rotation is set
        this.pitch = CrawlCameraHandler.clampPitchIfDowned(this.pitch);
    }
}
```

**Update dread.mixins.json** - Add CrawlCameraMixin to client array:

```json
"client": [
    "DeathScreenMixin",
    "ClientAttackMixin",
    "PlayerPoseMixin",
    "CrawlCameraMixin"
]
```

Key points:
- Injects at TAIL of setRotation to clamp after vanilla sets pitch
- MIN_PITCH of -30 allows looking slightly above horizon but not straight up
- MAX_PITCH of 90 allows full look down (normal)
- CrawlCameraHandler keeps logic separate for easy tuning
  </action>
  <verify>
Build succeeds. Test in-game:
1. Get downed by Dread entity
2. Try to look straight up - camera should stop at slight angle
3. Looking down should work normally
4. Get revived - full camera range should return
  </verify>
  <done>CrawlCameraMixin limits pitch when downed, CrawlCameraHandler registered</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   - `./gradlew build` succeeds with no errors
   - No mixin application errors in log

2. **Single-player visual test:**
   - Spawn Dread entity, let it kill you
   - Blood vignette (red edges) should appear on screen
   - Blood drip particles should appear around player
   - Try to look straight up - camera should be limited
   - Get revived - all visual effects should disappear

3. **Multiplayer test (if possible):**
   - Second player should see blood particles around downed first player
   - Vignette is client-side only (only downed player sees it)
</verification>

<success_criteria>
- CrawlVignetteRenderer.java exists and renders blood vignette when downed
- Blood drip particles spawn server-side around downed players
- CrawlCameraMixin limits camera pitch to -30 (can't look straight up)
- All visual effects appear when entering downed state
- All visual effects disappear when revived or transitioning to spectator
- Build completes successfully with all new code
</success_criteria>

<output>
After completion, create `.planning/phases/07-crawl-pose/07-03-SUMMARY.md`
</output>
