---
phase: 06-attack-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dread/death/AttackPreventionHandler.java
  - src/client/java/com/dread/mixin/ClientAttackMixin.java
  - src/main/resources/dread.mixins.json
  - src/main/java/com/dread/DreadMod.java
autonomous: true

must_haves:
  truths:
    - "Player cannot perform melee attacks while downed"
    - "Player cannot fire projectiles (bow, crossbow, trident) while downed"
    - "Attack inputs produce no animations or sounds when blocked"
  artifacts:
    - path: "src/main/java/com/dread/death/AttackPreventionHandler.java"
      provides: "Server-side attack blocking via Fabric callbacks"
      exports: ["register"]
    - path: "src/client/java/com/dread/mixin/ClientAttackMixin.java"
      provides: "Client-side attack animation cancellation"
      contains: "@Mixin(MinecraftClient.class)"
  key_links:
    - from: "src/main/java/com/dread/death/AttackPreventionHandler.java"
      to: "DownedPlayersState.isDowned()"
      via: "Server-side downed state check"
      pattern: "state\\.isDowned"
    - from: "src/client/java/com/dread/mixin/ClientAttackMixin.java"
      to: "DownedStateClientHandler.isDownedEffectActive()"
      via: "Client-side downed state check"
      pattern: "isDownedEffectActive"
---

<objective>
Block all player attacks (melee and projectile) while in downed state.

Purpose: Downed players should be helpless until revived - unable to fight back, reinforcing the horror of being down and dependent on teammates.

Output: Server-side callback handler blocks attacks authoritatively, client-side mixin prevents attack animations/sounds for smooth UX.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-attack-prevention/06-RESEARCH.md

# Key existing infrastructure
@src/main/java/com/dread/death/DownedPlayersState.java
@src/client/java/com/dread/client/DownedStateClientHandler.java
@src/main/java/com/dread/DreadMod.java
@src/main/resources/dread.mixins.json
@src/client/java/com/dread/mixin/DeathScreenMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server-side attack prevention handler</name>
  <files>
    src/main/java/com/dread/death/AttackPreventionHandler.java
    src/main/java/com/dread/DreadMod.java
  </files>
  <action>
Create AttackPreventionHandler.java in com.dread.death package with:

1. Static `register()` method that registers two Fabric callbacks:

   a. `AttackEntityCallback.EVENT.register()` for melee attacks:
      - Check if world instanceof ServerWorld
      - Get DownedPlayersState via getOrCreate(serverWorld)
      - If state.isDowned(player.getUuid()), return ActionResult.FAIL
      - Otherwise return ActionResult.PASS

   b. `UseItemCallback.EVENT.register()` for projectile weapons:
      - Check if world instanceof ServerWorld
      - Get DownedPlayersState via getOrCreate(serverWorld)
      - If state.isDowned(player.getUuid()):
        - Check if held item is RangedWeaponItem or TridentItem
        - If so, return TypedActionResult.fail(stack)
      - Otherwise return TypedActionResult.pass(stack)

2. Add logging for blocked attacks (debug level)

3. Update DreadMod.onInitialize() to call AttackPreventionHandler.register() after DreadDeathManager.register()

Imports needed:
- net.fabricmc.fabric.api.event.player.AttackEntityCallback
- net.fabricmc.fabric.api.event.player.UseItemCallback
- net.minecraft.util.ActionResult
- net.minecraft.util.TypedActionResult
- net.minecraft.server.world.ServerWorld
- net.minecraft.item.RangedWeaponItem
- net.minecraft.item.TridentItem
  </action>
  <verify>
Run: `export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && ./gradlew build --no-daemon`
Build should succeed with no compile errors.
  </verify>
  <done>
Server-side attack prevention handler exists, is registered in DreadMod, and compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side attack animation mixin</name>
  <files>
    src/client/java/com/dread/mixin/ClientAttackMixin.java
    src/main/resources/dread.mixins.json
  </files>
  <action>
Create ClientAttackMixin.java in com.dread.mixin package:

1. Follow existing DeathScreenMixin pattern for consistency
2. @Mixin(MinecraftClient.class) targeting the main client class
3. @Inject into "doAttack" method at HEAD with cancellable = true
4. Method signature: `private void dread$preventAttackWhenDowned(CallbackInfoReturnable<Boolean> cir)`
5. Check DownedStateClientHandler.isDownedEffectActive()
6. If downed:
   - cir.setReturnValue(false)
   - cir.cancel()

Update dread.mixins.json:
- Add "ClientAttackMixin" to the "client" array (after "DeathScreenMixin")

Imports needed:
- com.dread.client.DownedStateClientHandler
- net.minecraft.client.MinecraftClient
- org.spongepowered.asm.mixin.Mixin
- org.spongepowered.asm.mixin.injection.At
- org.spongepowered.asm.mixin.injection.Inject
- org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable
  </action>
  <verify>
Run: `export JAVA_HOME="X:/Vibe Coding/jdk-21.0.6+7" && ./gradlew build --no-daemon`
Build should succeed. Verify mixin is registered by checking build output for mixin application warnings.
  </verify>
  <done>
Client-side attack mixin exists, is registered in dread.mixins.json, and compiles successfully.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build succeeds: `./gradlew build --no-daemon` passes
2. No mixin errors in build output
3. AttackPreventionHandler.java exists with both callbacks
4. ClientAttackMixin.java exists with doAttack injection
5. dread.mixins.json includes ClientAttackMixin in client array
6. DreadMod.onInitialize() calls AttackPreventionHandler.register()

Functional verification (in-game):
- Enter downed state (get killed by Dread)
- Try left-click melee attack - should do nothing (no swing, no damage)
- Try right-click with bow/crossbow/trident - should do nothing (no draw)
- After revival, attacks should work normally again
</verification>

<success_criteria>
- Build compiles without errors
- All 3 success criteria from phase met:
  1. Melee attacks blocked server-side (AttackEntityCallback returns FAIL)
  2. Projectile attacks blocked server-side (UseItemCallback returns fail for weapons)
  3. Attack animations blocked client-side (doAttack mixin cancels)
- No animation glitches when attempting to attack while downed
</success_criteria>

<output>
After completion, create `.planning/phases/06-attack-prevention/06-01-SUMMARY.md`
</output>
